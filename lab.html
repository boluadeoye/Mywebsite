<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Writer's Foundry: Lab</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@800&display=swap" rel="stylesheet">
    <style>
        /* CSS Variables */
        :root {
            --bg: #f5f5dc; /* Beige background */
            --panel: #ffffff; /* White for cards */
            --ink: #2c3e50; /* Primary dark text */
            --muted: #596a7a; /* Muted/secondary text */
            --accent: #800000; /* Maroon/burgundy accent */
            --border-color: #dcd8cd; /* Subtle border color */
        }

        /* Base Styles */
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background-color: var(--bg);
            color: var(--ink);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
            text-rendering: optimizeLegibility; /* Critical for font appearance */
        }

        /* Main Card Container */
        .main-card {
            background-color: var(--panel);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            width: 100%;
            max-width: 500px;
            padding: 25px;
            box-sizing: border-box;
        }

        /* Header (CRITICAL) */
        .step-header {
            display: grid;
            grid-template-columns: auto 1fr auto; /* Back button | Title (centered) | Spacer */
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .back-button {
            background: none;
            border: none;
            color: var(--muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            margin: 0;
            line-height: 1; /* Ensures perfect alignment */
            justify-self: start;
            visibility: hidden; /* Hidden by default, shown when needed */
        }

        .back-button:hover {
            color: var(--accent);
        }

        .step-title {
            font-family: 'Playfair Display', serif;
            font-weight: 800;
            font-size: 1.8rem; /* Significantly smaller */
            color: var(--ink);
            text-align: center;
            margin: 0;
            padding: 0;
            line-height: 1.2;
            text-rendering: optimizeLegibility;
            grid-column: 2; /* Ensures it stays in the center column */
        }

        /* Content Area */
        .content-area {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* Choice Cards */
        .choice-card {
            background-color: #fcfcfc;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 18px 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            font-weight: bold;
            font-size: 1.1rem;
            color: var(--ink);
        }

        .choice-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border-color: var(--accent);
        }

        .choice-card.selected {
            background-color: var(--accent);
            color: var(--panel);
            border-color: var(--accent);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        /* Result Display */
        .result-section h3 {
            font-family: 'Playfair Display', serif;
            font-weight: 800;
            font-size: 1.5rem;
            color: var(--ink);
            margin-top: 0;
            margin-bottom: 15px;
            text-align: center;
        }

        .result-section p {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 10px;
            color: var(--ink);
        }

        .result-section strong {
            font-weight: bold; /* Ensures strong is bold even in sans-serif */
        }

        .result-detail-heading {
            font-size: 0.9rem;
            color: var(--ink);
            font-weight: bold;
            text-transform: uppercase;
            margin-top: 20px;
            margin-bottom: 5px;
            letter-spacing: 0.05em;
        }

        /* Action Cards (for result page navigation) */
        .action-card {
            background-color: #fcfcfc;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .action-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border-color: var(--accent);
        }

        .action-card-title {
            font-family: 'Playfair Display', serif;
            font-weight: 800;
            font-size: 1.3rem;
            color: var(--ink);
            margin: 0;
            line-height: 1.2;
        }

        .action-card-description {
            font-size: 0.95rem;
            color: var(--muted);
            margin: 0;
        }

        /* Primary Button */
        .btn-primary {
            background-color: var(--accent);
            color: var(--panel);
            border: none;
            border-radius: 8px;
            padding: 15px 25px;
            font-family: 'Playfair Display', serif; /* Serif font for primary buttons */
            font-weight: 800;
            font-size: 1.2rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            margin-top: 20px;
            width: 100%;
            box-sizing: border-box;
            text-rendering: optimizeLegibility;
        }

        .btn-primary:hover {
            background-color: #6a0000; /* Darker accent */
        }

        .btn-secondary {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--ink);
            font-family: system-ui, -apple-system, sans-serif;
            font-weight: normal;
            font-size: 1rem;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            margin-top: 10px;
            width: 100%;
            box-sizing: border-box;
        }

        .btn-secondary:hover {
            border-color: var(--accent);
            color: var(--accent);
            background-color: #f9f0f0;
        }

        /* Utility classes */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .mt-20 {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="main-card">
        <div class="step-header">
            <button class="back-button" id="backButton" aria-label="Go back">‚Üê</button>
            <h2 class="step-title" id="stepTitle">Core Idea</h2>
            <div></div> <!-- Empty div for spacing to ensure title centering -->
        </div>

        <div class="content-area" id="contentArea">
            <!-- Content will be dynamically loaded here by JavaScript -->
        </div>
    </div>

    <script>
        const contentArea = document.getElementById('contentArea');
        const stepTitle = document.getElementById('stepTitle');
        const backButton = document.getElementById('backButton');

        let foundryData = {};
        let currentStep = 0; // 0: Core Idea, 1: Archetype, 2: Catalyst, 3: Result
        let history = []; // Stores previous steps for back button functionality

        let selectedCoreIdea = null;
        let selectedArchetype = null;
        let selectedCatalystQuestion = null;
        let generatedLogline = null;
        let generatedDeepDiveQuestion = null;
        let generatedSettingDetails = null;

        // --- Fetch Data ---
        async function fetchFoundryData() {
            try {
                const response = await fetch('foundry-data.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                foundryData = await response.json();
                console.log("Foundry data loaded:", foundryData);
                renderStep(0); // Start the journey
            } catch (error) {
                console.error("Could not load foundry-data.json:", error);
                contentArea.innerHTML = `<p style="color: var(--accent); text-align: center;">Error loading creative data. Please try again later.</p>`;
            }
        }

        // --- Navigation & History ---
        function goToStep(stepIndex, saveHistory = true) {
            if (saveHistory && currentStep !== stepIndex) {
                history.push(currentStep);
            }
            currentStep = stepIndex;
            renderStep(currentStep);
            updateBackButtonVisibility();
        }

        function goBack() {
            if (history.length > 0) {
                const prevStep = history.pop();
                goToStep(prevStep, false); // Don't save current step to history when going back
            }
        }

        function updateBackButtonVisibility() {
            backButton.style.visibility = currentStep === 0 ? 'hidden' : 'visible';
        }

        backButton.addEventListener('click', goBack);

        // --- Render Functions for Each Step ---

        function renderStep(step) {
            contentArea.innerHTML = ''; // Clear previous content

            switch (step) {
                case 0: // Core Idea
                    stepTitle.textContent = 'Core Idea';
                    contentArea.innerHTML = `
                        <div class="choice-card" data-choice="Character">Character</div>
                        <div class="choice-card" data-choice="Setting">Setting</div>
                        <div class="choice-card" data-choice="Theme">Theme</div>
                    `;
                    addChoiceCardListeners(contentArea.querySelectorAll('.choice-card'), handleCoreIdeaSelection);
                    break;

                case 1: // Archetype Choice (if Character selected)
                    if (selectedCoreIdea !== 'Character' || !foundryData.characters || !foundryData.characters.archetypes) {
                        console.error("Invalid state for step 1. Core idea not character or data missing.");
                        goToStep(0); // Go back if state is bad
                        return;
                    }
                    stepTitle.textContent = 'Choose Archetype';
                    foundryData.characters.archetypes.forEach(archetype => {
                        const card = document.createElement('div');
                        card.className = 'choice-card';
                        card.textContent = archetype.name;
                        card.dataset.archetype = archetype.name;
                        contentArea.appendChild(card);
                    });
                    addChoiceCardListeners(contentArea.querySelectorAll('.choice-card'), handleArchetypeSelection);
                    break;

                case 2: // Catalyst Question (if Archetype selected)
                    if (!selectedArchetype) {
                        console.error("Invalid state for step 2. Archetype not selected.");
                        goToStep(1); // Go back if state is bad
                        return;
                    }
                    stepTitle.textContent = 'Consider This';
                    const archetypeData = foundryData.characters.archetypes.find(a => a.name === selectedArchetype);
                    if (!archetypeData || !archetypeData.catalyst_questions || archetypeData.catalyst_questions.length === 0) {
                        contentArea.innerHTML = `<p class="text-center">No catalyst questions available for this archetype.</p>`;
                        return;
                    }

                    const questionContainer = document.createElement('div');
                    questionContainer.className = 'content-area';
                    questionContainer.innerHTML = `
                        <p class="text-center" style="font-style: italic; color: var(--muted);">What sparks their journey?</p>
                    `;
                    const questionsList = document.createElement('div');
                    questionsList.style.display = 'flex';
                    questionsList.style.flexDirection = 'column';
                    questionsList.style.gap = '10px';

                    archetypeData.catalyst_questions.forEach((question, index) => {
                        const card = document.createElement('div');
                        card.className = 'choice-card';
                        card.textContent = question;
                        card.dataset.question = question;
                        questionsList.appendChild(card);
                    });
                    questionContainer.appendChild(questionsList);
                    contentArea.appendChild(questionContainer);
                    addChoiceCardListeners(contentArea.querySelectorAll('.choice-card'), handleCatalystSelection);
                    break;

                case 3: // Final Result
                    stepTitle.textContent = 'Forged Idea';
                    generateFinalIdea(); // Generate the idea before displaying
                    contentArea.innerHTML = `
                        <div class="result-section">
                            <h3 class="text-center">Your Story Seed</h3>
                            <p class="result-detail-heading">Logline:</p>
                            <p>${generatedLogline}</p>

                            <p class="result-detail-heading">Deep Dive Question:</p>
                            <p>${generatedDeepDiveQuestion}</p>

                            ${generatedSettingDetails ? `
                                <p class="result-detail-heading">Setting Vibe:</p>
                                <p>${generatedSettingDetails}</p>
                            ` : ''}

                            <div class="content-area mt-20">
                                <div class="action-card" onclick="window.location.href='anvil.html?idea=' + encodeURIComponent(generatedLogline);">
                                    <h4 class="action-card-title">Take to Anvil</h4>
                                    <p class="action-card-description">Refine and expand this idea in the writing editor.</p>
                                </div>
                                <div class="action-card" onclick="window.location.href='journal.html?idea=' + encodeURIComponent(generatedLogline);">
                                    <h4 class="action-card-title">Save to Journal</h4>
                                    <p class="action-card-description">Keep this idea for later in your personal log.</p>
                                </div>
                                <button class="btn-secondary" onclick="startOver()">Start Over</button>
                            </div>
                        </div>
                    `;
                    break;
            }
        }

        // --- Event Handlers ---
        function addChoiceCardListeners(cards, handler) {
            cards.forEach(card => {
                card.addEventListener('click', (event) => {
                    // Remove 'selected' from all cards first
                    cards.forEach(c => c.classList.remove('selected'));
                    // Add 'selected' to the clicked card
                    event.currentTarget.classList.add('selected');

                    // Allow a slight visual delay before advancing for better UX
                    setTimeout(() => {
                        handler(event);
                    }, 200);
                });
            });
        }

        function handleCoreIdeaSelection(event) {
            selectedCoreIdea = event.currentTarget.dataset.choice;
            if (selectedCoreIdea === 'Character') {
                goToStep(1);
            } else {
                // For 'Setting' or 'Theme', directly generate a result for now (simplification as per brief)
                // In a full app, these would lead to their own selection steps
                goToStep(3);
            }
        }

        function handleArchetypeSelection(event) {
            selectedArchetype = event.currentTarget.dataset.archetype;
            goToStep(2);
        }

        function handleCatalystSelection(event) {
            selectedCatalystQuestion = event.currentTarget.dataset.question;
            goToStep(3);
        }

        function generateFinalIdea() {
            let logline = "A captivating story where ";
            let deepDiveQuestion = "What is the true cost of their journey?";
            let settingDetails = null;

            if (selectedCoreIdea === 'Character' && selectedArchetype) {
                const archetype = foundryData.characters.archetypes.find(a => a.name === selectedArchetype);
                if (archetype) {
                    const randomConflict = foundryData.conflicts.external[Math.floor(Math.random() * foundryData.conflicts.external.length)];
                    const randomSetting = foundryData.settings.locations[Math.floor(Math.random() * foundryData.settings.locations.length)];

                    logline = `In a ${randomSetting.name}, a **${archetype.name}** who is motivated ${archetype.motivation} must confront ${randomConflict.text} to achieve their goal, risking **${archetype.flaw}**.`;
                    deepDiveQuestion = selectedCatalystQuestion || `How does their inherent **${archetype.flaw}** impact their struggle against ${randomConflict.text}?`;
                    
                    if (randomSetting) {
                        settingDetails = `
                            **Sight:** ${randomSetting.sensory_palette.sight}<br>
                            **Sound:** ${randomSetting.sensory_palette.sound}<br>
                            **Smell:** ${randomSetting.sensory_palette.smell}
                        `;
                    }
                }
            } else if (selectedCoreIdea === 'Setting') {
                const randomSetting = foundryData.settings.locations[Math.floor(Math.random() * foundryData.settings.locations.length)];
                if (randomSetting) {
                    const randomConflict = foundryData.conflicts.external[Math.floor(Math.random() * foundryData.conflicts.external.length)];
                    logline = `In **${randomSetting.name}**, a desperate individual must overcome **${randomConflict.text}** to find hope amidst the oppressive environment.`;
                    deepDiveQuestion = `How does the unique atmosphere of ${randomSetting.name} shape the protagonist's inner turmoil?`;
                    settingDetails = `
                        **Sight:** ${randomSetting.sensory_palette.sight}<br>
                        **Sound:** ${randomSetting.sensory_palette.sound}<br>
                        **Smell:** ${randomSetting.sensory_palette.smell}
                    `;
                }
            } else if (selectedCoreIdea === 'Theme') {
                 // Placeholder for theme-based generation
                 logline = `A story exploring the complex themes of **redemption and sacrifice** in a world where moral lines are blurred.`;
                 deepDiveQuestion = `To what lengths will a character go to achieve redemption, and what must they sacrifice along the way?`;
                 const randomSetting = foundryData.settings.locations[Math.floor(Math.random() * foundryData.settings.locations.length)];
                 if (randomSetting) {
                    settingDetails = `
                        **Sight:** ${randomSetting.sensory_palette.sight}<br>
                        **Sound:** ${randomSetting.sensory_palette.sound}<br>
                        **Smell:** ${randomSetting.sensory_palette.smell}
                    `;
                 }
            } else {
                 // Default fallback if no specific path taken
                 logline = "A compelling narrative about an unexpected journey and a profound discovery.";
                 deepDiveQuestion = "What hidden truths will be unearthed when the world shifts on its axis?";
            }

            generatedLogline = logline;
            generatedDeepDiveQuestion = deepDiveQuestion;
            generatedSettingDetails = settingDetails;
        }


        function startOver() {
            selectedCoreIdea = null;
            selectedArchetype = null;
            selectedCatalystQuestion = null;
            generatedLogline = null;
            generatedDeepDiveQuestion = null;
            generatedSettingDetails = null;
            history = []; // Clear history
            goToStep(0);
        }

        // --- Initialize ---
        fetchFoundryData();
    </script>
</body>
</html>
