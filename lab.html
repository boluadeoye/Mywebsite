<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>The Writer's Foundry — Boluadeoye</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@800&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-dark: #0f172a; --panel-dark: #111a2e;
      --ink-dark: #e5eefc; --muted-dark: #94a3b8;
      --bg: #f5f5dc; --panel: #ffffff;
      --ink: #2c3e50; --muted: #596a7a;
      --accent: #800000; --accent-light: #a00000;
      --accent-ink: #f5f5dc; --border-color: #dcd8cd;
      --radius: 12px; --serif: 'Playfair Display', Georgia, serif;
      --sans-serif: system-ui, -apple-system, 'Segoe UI', Roboto, Inter, Arial, sans-serif;
      --transition: cubic-bezier(0.4, 0, 0.2, 1);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }
    body {
      background: var(--bg); color: var(--ink);
      font: 16px/1.7 var(--sans-serif);
      -webkit-font-smoothing: antialiased;
    }
    .wrap { max-width: 800px; margin: 0 auto; padding: 0 1.5rem; }
    .page-header { text-align: center; padding: 3rem 0 2rem; }
    .page-header h1 {
      font-size: clamp(2.5rem, 5vw, 4rem);
      font-family: var(--serif); margin-bottom: 0.5rem;
      line-height: 1.1; color: var(--accent);
    }
    .page-header p {
      font-size: 1.1rem; color: var(--muted);
      max-width: 65ch; margin: 0 auto;
    }
    .foundry {
      margin: 2rem auto; padding: 2.5rem;
      background: var(--panel); border: 1px solid var(--border-color);
      border-radius: var(--radius);
      box-shadow: 0 10px 40px rgba(0,0,0,0.08);
      min-height: 400px;
      display: flex; flex-direction: column;
      transition: all 0.5s var(--transition);
    }
    .step-container { animation: fadeIn 0.5s var(--transition); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    .step-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
    .step-title {
      font-family: var(--serif); font-size: 1.5rem;
      text-align: center; flex-grow: 1;
    }
    .btn-back {
      background: none; border: none; font-size: 1rem;
      font-weight: 700; color: var(--muted); cursor: pointer;
      padding: 0.5rem;
    }
    .btn-back:hover { color: var(--accent); }
    .btn-back.hidden { visibility: hidden; }
    
    .choice-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem; margin-top: 1rem;
    }
    .choice-card, .btn-primary {
      padding: 1rem 1.5rem; background: var(--bg);
      border: 1px solid var(--border-color);
      border-radius: 8px; font-size: 1rem;
      font-weight: 700; text-align: center;
      cursor: pointer; transition: all 0.2s var(--transition);
      width: 100%;
    }
    .choice-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.07);
      border-color: var(--accent); color: var(--accent);
    }
    
    .result-container { text-align: left; }
    .result-container h3 {
        font-family: var(--serif); font-size: 1.1rem;
        text-transform: uppercase; letter-spacing: 1px;
        color: var(--muted); border-bottom: 1px solid var(--border-color);
        padding-bottom: 0.5rem; margin: 1.5rem 0 1rem;
    }
    .result-container p { font-size: 1.1rem; line-height: 1.7; }
    .result-container ul { list-style: none; padding-left: 1rem; border-left: 2px solid var(--accent); }
    .result-container li { font-size: 0.95rem; color: var(--muted); margin-bottom: 0.5rem; font-style: italic; }

    .btn-primary {
      background: var(--accent); color: var(--accent-ink);
      border: none; margin-top: 2rem;
    }
    .btn-primary:hover {
        background: var(--accent-light);
        box-shadow: 0 4px 20px rgba(128, 0, 0, 0.25);
    }
    
    footer { 
        background: var(--panel-dark); color: var(--muted-dark);
        text-align: center; font-size: 0.88rem;
        padding: 2rem 0; margin-top: 4rem; 
    }
  </style>
</head>
<body>
  <main class="wrap">
    <section class="page-header">
        <h1>The Writer's Foundry</h1>
        <p>An intelligent engine to forge inspiration from raw ideas.</p>
    </section>
    
    <section id="foundry" class="foundry"></section>
  </main>
  <footer><div class="wrap"><p>© 2025 Boluadeoye • Crafted with passion</p></div></footer>

  <script>
    (function(){
      const foundryContainer = document.getElementById('foundry');
      let foundryData = null;
      let userSelections = {};
      let navigationHistory = [];

      const navigateTo = (stepFunction) => {
        navigationHistory.push(stepFunction);
        stepFunction();
      };

      const goBack = () => {
        if (navigationHistory.length > 1) {
          navigationHistory.pop(); // Remove current step
          const previousStep = navigationHistory[navigationHistory.length - 1];
          previousStep(); // Render previous step
        }
      };

      const renderHeader = (title, showBack) => {
        return `
          <div class="step-header">
            <button class="btn-back ${showBack ? '' : 'hidden'}">← Back</button>
            <h2 class="step-title">${title}</h2>
            <div style="width: 50px;"></div> </div>
        `;
      };
      
      const attachBackListener = () => {
          const backButton = foundryContainer.querySelector('.btn-back');
          if (backButton) {
              backButton.addEventListener('click', goBack);
          }
      };

      const renderStep1 = () => {
        foundryContainer.innerHTML = `
          <div class="step-container">
            ${renderHeader('What is the core of your idea?', false)}
            <div class="choice-grid">
              <button class="choice-card" data-choice="character">Character</button>
              <button class="choice-card" data-choice="setting">Setting</button>
              <button class="choice-card" data-choice="theme">Theme</button>
            </div>
          </div>
        `;
        foundryContainer.querySelectorAll('.choice-card').forEach(card => {
          card.addEventListener('click', (e) => {
            userSelections = { core: e.target.dataset.choice }; // Reset selections
            navigateTo(renderStep2);
          });
        });
        attachBackListener();
      };
      
      const renderStep2 = () => {
        const archetypes = foundryData.characters.archetypes;
        foundryContainer.innerHTML = `
          <div class="step-container">
            ${renderHeader('Choose a Character Archetype', true)}
            <div class="choice-grid">
              ${archetypes.map(a => `<button class="choice-card" data-choice="${a.name}">${a.name}</button>`).join('')}
            </div>
          </div>
        `;
        foundryContainer.querySelectorAll('.choice-card').forEach(card => {
          card.addEventListener('click', (e) => {
            const choice = e.target.dataset.choice;
            userSelections.archetype = foundryData.characters.archetypes.find(a => a.name === choice);
            navigateTo(renderStep3);
          });
        });
        attachBackListener();
      };
      
      const renderStep3 = () => {
        const questions = userSelections.archetype.catalyst_questions;
        if (!questions || questions.length === 0) {
            navigateTo(renderFinalResult); // Skip if no questions
            return;
        }
        foundryContainer.innerHTML = `
          <div class="step-container">
            ${renderHeader('Consider this...', true)}
            <div class="choice-grid" style="grid-template-columns: 1fr;">
              ${questions.map((q, index) => `<button class="choice-card" data-choice="${index}">${q}</button>`).join('')}
            </div>
          </div>
        `;
        foundryContainer.querySelectorAll('.choice-card').forEach(card => {
          card.addEventListener('click', (e) => {
            const choiceIndex = parseInt(e.target.dataset.choice, 10);
            userSelections.question = questions[choiceIndex];
            navigateTo(renderFinalResult);
          });
        });
        attachBackListener();
      };

      const renderFinalResult = () => {
          const char = userSelections.archetype;
          const conflict = foundryData.conflicts.external.find(c => c.tags.some(t => char.tags.includes(t))) || foundryData.conflicts.external[0];
          const setting = foundryData.settings.locations.find(s => s.tags.some(t => char.tags.includes(t))) || foundryData.settings.locations[0];
          
          userSelections.result = {
              logline: `In the world of ${setting.name}, a character like ${char.name}, who is motivated by a desire to "${char.motivation}" but is held back by their flaw of "${char.flaw}", must face the conflict of ${conflict.text}`,
              question: userSelections.question || "Consider their core motivation and flaw.",
              setting: setting
          };

          foundryContainer.innerHTML = `
            <div class="step-container result-container">
                ${renderHeader('Your Forged Idea', true)}
                
                <h3>Logline</h3>
                <p>${userSelections.result.logline}</p>
                
                <h3>Deep Dive Question</h3>
                <p><em>${userSelections.result.question}</em></p>

                <h3>Setting: ${setting.name}</h3>
                <div class="sensory-palette">
                    <ul>
                        <li><strong>Sight:</strong> ${setting.sensory_palette.sight}</li>
                        <li><strong>Sound:</strong> ${setting.sensory_palette.sound}</li>
                        <li><strong>Smell:</strong> ${setting.sensory_palette.smell}</li>
                    </ul>
                </div>
                
                <h3>Next Steps</h3>
                <div class="choice-grid" style="grid-template-columns: 1fr 1fr;">
                  <button class="choice-card" id="anvilBtn">Take to 'The Anvil'</button>
                  <button class="choice-card" id="journalBtn">Save to Journal</button>
                </div>

                <button id="restartBtn" class="btn-primary">Start a New Idea</button>
            </div>
          `;
          foundryContainer.querySelector('#restartBtn').addEventListener('click', () => {
              userSelections = {};
              navigationHistory = [];
              navigateTo(renderStep1);
          });
          foundryContainer.querySelector('#anvilBtn').addEventListener('click', takeToAnvil);
          foundryContainer.querySelector('#journalBtn').addEventListener('click', saveToJournal);
          attachBackListener();
      };
      
      const takeToAnvil = () => {
          localStorage.setItem('foundryAnvilPrompt', JSON.stringify(userSelections.result));
          window.location.href = './anvil.html';
      };

      const saveToJournal = (e) => {
          let journal = JSON.parse(localStorage.getItem('foundryJournal')) || [];
          journal.unshift(userSelections.result); // Add to the beginning
          localStorage.setItem('foundryJournal', JSON.stringify(journal));
          const btn = e.target;
          btn.textContent = 'Saved!';
          btn.style.backgroundColor = '#27ae60';
          setTimeout(() => {
              btn.textContent = "Save to Journal";
              btn.style.backgroundColor = 'var(--bg)';
          }, 1500);
      };

      async function initializeFoundry() {
        try {
          const response = await fetch('./foundry-data.json');
          if (!response.ok) throw new Error('Could not load the Foundry brain.');
          foundryData = await response.json();
          navigateTo(renderStep1);
        } catch (error) {
          foundryContainer.innerHTML = `<p style="color: #c0392b; text-align: center;">Error: ${error.message}</p>`;
        }
      }

      document.addEventListener('DOMContentLoaded', initializeFoundry);
    })();
  </script>
</body>
</html>
