<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Boluadeoye</title>
    <style>
        /* Basic mobile-friendly styles */
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        h1 { color: #f59e0b; text-align: center; }
        .container { background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input, textarea, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        button { background: #f59e0b; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px 0; }
        button:hover { background: #d97706; }
        .preview { margin-top: 20px; background: #f9f9f9; padding: 15px; border-radius: 5px; }
        .post-preview { border: 1px solid #eee; margin-bottom: 20px; padding: 15px; border-radius: 5px; }
        .post-actions { margin-top: 10px; }
        .post-actions button { margin-right: 10px; background: #4CAF50; }
        .post-actions button.delete { background: #f44336; }
        .image-upload { margin-bottom: 15px; }
        .image-preview { margin-top: 10px; }
        .image-preview img { max-width: 100%; margin-bottom: 10px; }
        .file-list { margin-top: 20px; }
        .file-list h3 { margin-bottom: 10px; color: #f59e0b; }
        #status { padding: 10px; margin-bottom: 15px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Admin Panel</h1>
        
        <div id="loginSection">
            <div class="form-group">
                <label for="username">GitHub Username</label>
                <input type="text" id="username" placeholder="your-github-username">
            </div>
            <div class="form-group">
                <label for="repo">Repository Name</label>
                <input type="text" id="repo" value="Mywebsite">
            </div>
            <div class="form-group">
                <label for="token">GitHub Personal Access Token</label>
                <input type="password" id="token" placeholder="ghp_xxxxxxxxxxxxxxxxxx">
            </div>
            <button onclick="login()">Login</button>
            <div id="status"></div>
        </div>
        
        <div id="adminSection" style="display: none;">
            <h2>Create New Post</h2>
            <div id="postStatus"></div>
            <div class="form-group">
                <label for="postTitle">Post Title</label>
                <input type="text" id="postTitle" placeholder="Enter post title" oninput="updatePreview()">
            </div>
            <div class="form-group">
                <label for="postType">Post Type</label>
                <select id="postType">
                    <option value="faith">Faith</option>
                    <option value="poems">Poems</option>
                    <option value="stories">Stories</option>
                    <option value="devotional">Devotional</option>
                    <option value="articles">Articles</option>
                    <option value="essays">Essays</option>
                </select>
            </div>
            <div class="form-group">
                <label for="postExcerpt">Excerpt</label>
                <input type="text" id="postExcerpt" placeholder="Short description">
            </div>
            <div class="form-group">
                <label for="postContent">Content (Markdown)</label>
                <textarea id="postContent" rows="15" oninput="updatePreview()"></textarea>
            </div>
            <button onclick="publishPost()">Publish Post</button>
            
            <div class="preview-section">
                <h3>Preview</h3>
                <div class="preview" id="preview"></div>
            </div>
            
            <div class="image-upload">
                <h3>Upload Image</h3>
                <input type="file" id="imageFile" accept="image/*">
                <button onclick="uploadImage()">Upload</button>
                <div id="imageStatus"></div>
                <div class="image-preview" id="imagePreview"></div>
            </div>
            
            <div class="file-list">
                <h3>Existing Posts</h3>
                <div id="postsList"></div>
            </div>
            
            <div class="file-list">
                <h3>Uploaded Images</h3>
                <div id="imagesList"></div>
            </div>
        </div>
    </div>

    <script>
        let githubConfig = {};
        
        function login() {
            const username = document.getElementById('username').value;
            const repo = document.getElementById('repo').value;
            const token = document.getElementById('token').value;
            
            if (!username || !repo || !token) {
                showStatus('status', 'Please fill all fields', 'error');
                return;
            }
            
            githubConfig = { username, repo, token };
            localStorage.setItem('githubConfig', JSON.stringify(githubConfig));
            
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('adminSection').style.display = 'block';
            
            loadPosts();
            loadImages();
        }
        
        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.className = type;
            element.textContent = message;
            element.style.display = 'block';
            setTimeout(() => element.style.display = 'none', 3000);
        }
        
        function updatePreview() {
            const title = document.getElementById('postTitle').value;
            const content = document.getElementById('postContent').value;
            const preview = document.getElementById('preview');
            preview.innerHTML = `<h2>${title}</h2><p>${content.replace(/\n/g, '<br>')}</p>`;
        }
        
        async function publishPost() {
            const title = document.getElementById('postTitle').value;
            const type = document.getElementById('postType').value;
            const excerpt = document.getElementById('postExcerpt').value;
            const content = document.getElementById('postContent').value;
            
            if (!title || !content) {
                showStatus('postStatus', 'Please enter title and content', 'error');
                return;
            }
            
            const filename = title.toLowerCase().replace(/\s+/g, '-') + '.md';
            const date = new Date().toISOString().split('T');
            
            try {
                // Create the markdown file
                await githubAPI('PUT', `contents/posts/${filename}`, {
                    message: `Add post: ${title}`,
                    content: btoa(content)
                });
                
                // Update Posts.json
                const posts = await getPostsJson();
                posts.push({
                    title: title,
                    date: date,
                    type: type,
                    excerpt: excerpt,
                    file: `posts/${filename}`,
                    likes: 0,
                    views: 0
                });
                
                await githubAPI('PUT', 'contents/Posts.json', {
                    message: `Update Posts.json for ${title}`,
                    content: btoa(JSON.stringify(posts, null, 2)),
                    sha: posts.sha
                });
                
                showStatus('postStatus', 'Post published successfully!', 'success');
                loadPosts();
                
            } catch (error) {
                showStatus('postStatus', 'Error publishing post', 'error');
            }
        }
        
        async function uploadImage() {
            const file = document.getElementById('imageFile').files;
            if (!file) {
                showStatus('imageStatus', 'Please select an image', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const base64 = e.target.result.split(',');
                    const filename = file.name;
                    
                    await githubAPI('PUT', `contents/images/${filename}`, {
                        message: `Upload image: ${filename}`,
                        content: base64
                    });
                    
                    showStatus('imageStatus', 'Image uploaded successfully!', 'success');
                    loadImages();
                } catch (error) {
                    showStatus('imageStatus', 'Error uploading image', 'error');
                }
            };
            reader.readAsDataURL(file);
        }
        
        async function loadPosts() {
            try {
                const response = await githubAPI('GET', 'contents/posts');
                const postsList = document.getElementById('postsList');
                postsList.innerHTML = '';
                
                response.filter(item => item.name.endsWith('.md')).forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'post-preview';
                    div.innerHTML = `
                        <h4>${item.name.replace('.md', '')}</h4>
                        <div class="post-actions">
                            <button onclick="deletePost('${item.name}')">Delete</button>
                        </div>
                    `;
                    postsList.appendChild(div);
                });
            } catch (error) {
                console.error('Error loading posts:', error);
            }
        }
        
        async function loadImages() {
            try {
                const response = await githubAPI('GET', 'contents/images');
                const imagesList = document.getElementById('imagesList');
                imagesList.innerHTML = '';
                
                response.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'image-preview';
                    div.innerHTML = `
                        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAHElEQVQI12P4//8/w38GIAXDIBKE0DHxgljNBAAO9TXL0Y4OHwAAAABJRU5ErkJggg==" alt="${item.name}" loading="lazy">
                        <p>${item.name}</p>
                        <div class="post-actions">
                            <button onclick="deleteImage('${item.name}')">Delete</button>
                        </div>
                    `;
                    imagesList.appendChild(div);
                });
            } catch (error) {
                console.error('Error loading images:', error);
            }
        }
        
        async function deletePost(filename) {
            if (!confirm(`Are you sure you want to delete ${filename}?`)) return;
            
            try {
                // Delete the file
                const response = await githubAPI('DELETE', `contents/posts/${filename}`);
                
                // Update Posts.json
                const posts = await getPostsJson();
                const updatedPosts = posts.filter(p => p.file !== `posts/${filename}`);
                
                await githubAPI('PUT', 'contents/Posts.json', {
                    message: `Delete post: ${filename}`,
                    content: btoa(JSON.stringify(updatedPosts, null, 2)),
                    sha: posts.sha
                });
                
                showStatus('postStatus', 'Post deleted successfully!', 'success');
                loadPosts();
            } catch (error) {
                showStatus('postStatus', 'Error deleting post', 'error');
            }
        }
        
        async function deleteImage(filename) {
            if (!confirm(`Are you sure you want to delete ${filename}?`)) return;
            
            try {
                await githubAPI('DELETE', `contents/images/${filename}`);
                showStatus('imageStatus', 'Image deleted successfully!', 'success');
                loadImages();
            } catch (error) {
                showStatus('imageStatus', 'Error deleting image', 'error');
            }
        }
        
        async function getPostsJson() {
            const response = await githubAPI('GET', 'contents/Posts.json');
            response.content = JSON.parse(atob(response.content));
            return response;
        }
        
        async function githubAPI(method, path, body = null) {
            const url = `https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/${path}`;
            const headers = {
                'Authorization': `token ${githubConfig.token}`,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
            };
            
            const response = await fetch(url, {
                method: method,
                headers: headers,
                body: body ? JSON.stringify(body) : null
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message);
            }
            
            return await response.json();
        }
        
        // Auto load if already logged in
        const savedConfig = localStorage.getItem('githubConfig');
        if (savedConfig) {
            githubConfig = JSON.parse(savedConfig);
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('adminSection').style.display = 'block';
            loadPosts();
            loadImages();
        }
    </script>
</body>
</html>
