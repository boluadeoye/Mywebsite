<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Blog Admin Panel</title>
<style>
:root{--bg:#0f172a;--panel:#111a2e;--ink:#e5eefc;--muted:#94a3b8;--orange:#f59e0b;--orange-ink:#0b0f19;--radius:12px}
*{box-sizing:border-box;font-family:system-ui,sans-serif}
body{margin:0;padding:1rem;background:var(--bg);color:var(--ink)}
h1,h2{font-family:ui-serif,Georgia,serif;color:var(--orange);text-align:center;margin-bottom:1.5rem}
h1{font-size:2rem}h2{font-size:1.5rem}
.container{max-width:800px;margin:auto}
.card{background:var(--panel);padding:1.5rem;border-radius:var(--radius);margin-bottom:1.5rem;border:1px solid rgba(255,255,255,.06)}
.form-group{margin-bottom:1rem}
label{display:block;margin-bottom:.5rem;font-weight:600}
input,textarea,select{width:100%;padding:.75rem;background:var(--bg);border:1px solid rgba(255,255,255,.1);border-radius:8px;color:var(--ink);font-size:1rem}
input:focus,textarea:focus,select:focus{outline:none;border-color:var(--orange)}
textarea{min-height:250px;font-family:monospace}
button{background:var(--orange);color:var(--orange-ink);padding:.75rem 1.5rem;border:none;border-radius:999px;font-weight:700;cursor:pointer;font-size:.9rem;margin-top:1rem}
button:disabled{opacity:.5;cursor:not-allowed}
.status{padding:1rem;border-radius:8px;margin-top:1rem;display:none}
.status.ok{background:rgba(34,197,94,.1);color:#22c55e}
.status.err{background:rgba(239,68,68,.1);color:#ef4444}
.status.info{background:rgba(245,158,11,.1);color:var(--orange)}
.file-item{background:var(--bg);padding:.75rem;margin-bottom:.5rem;border-radius:8px;display:flex;justify-content:space-between;align-items:center}
.file-item button{background:rgba(239,68,68,.1);color:#ef4444;padding:.5rem 1rem;font-size:.8rem;margin-top:0}
</style>
</head>
<body>
  <div class="container">
    <h1>Blog Admin Panel</h1>

    <!-- ========== LOGIN ========= -->
    <div id="loginSection" class="card">
      <h2>Login</h2>
      <div id="loginStatus" class="status"></div>
      <div class="form-group"><label>GitHub Username</label><input id="username"></div>
      <div class="form-group"><label>Repository Name</label><input id="repo" value="Mywebsite"></div>
      <div class="form-group"><label>GitHub Token</label><input id="token" type="password"></div>
      <button id="loginBtn">Login</button>
    </div>

    <!-- ========== DASHBOARD ========= -->
    <div id="adminPanel" style="display:none;">
      <!-- Create Post -->
      <div class="card">
        <h2>Create New Post</h2>
        <div id="postStatus" class="status"></div>
        <div class="form-group"><label>Title</label><input id="postTitle"></div>
        <div class="form-group"><label>Category</label>
          <select id="postType">
            <option value="faith">Faith</option><option value="poems">Poems</option>
            <option value="stories">Stories</option><option value="devotional">Devotional</option>
            <option value="articles">Articles</option><option value="essays">Essays</option>
          </select>
        </div>
        <div class="form-group"><label>Excerpt</label><input id="postExcerpt"></div>
        <div class="form-group"><label>Content (Markdown)</label><textarea id="postContent"></textarea></div>
        <button id="publishBtn">Publish Post</button>
      </div>

      <!-- Manage Posts -->
      <div class="card">
        <h2>Manage Posts</h2>
        <div id="manageStatus" class="status"></div>
        <div id="postsList"></div>
      </div>

      <!-- Tools -->
      <div class="card">
        <h2>Tools</h2>
        <div id="toolStatus" class="status"></div>
        <p style="color:var(--muted);margin-bottom:1rem;">Use this to find and fix posts that are in your `Posts.json` but are missing their markdown file.</p>
        <button id="fixBtn">Check & Fix Missing Files</button>
        <div id="fixResults" style="margin-top:1rem;"></div>
      </div>
    </div>
  </div>

  <!-- ========= SCRIPT ========= -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const $ = id => document.getElementById(id);
      let githubConfig = {};

      // --- UI & Status ---
      function showStatus(elId, msg, type) {
        const el = $(elId);
        el.textContent = msg;
        el.className = 'status ' + type;
        el.style.display = 'block';
        if (type !== 'error') {
          setTimeout(() => { el.style.display = 'none'; }, 5000);
        }
      }

      function showDashboard() {
        $('loginSection').style.display = 'none';
        $('adminPanel').style.display = 'block';
        loadPosts();
      }

      // --- GitHub API Helper ---
      async function fetchGH(method, path, body) {
        const url = `https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/${path.startsWith('/') ? path.substring(1) : path}`;
        const options = {
          method,
          headers: {
            'Authorization': `token ${githubConfig.token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        };
        if (body) {
          options.headers['Content-Type'] = 'application/json';
          options.body = JSON.stringify(body);
        }
        const res = await fetch(url, options);
        if (!res.ok) {
          const errorText = await res.text();
          throw new Error(`GitHub API Error (${res.status}): ${errorText.slice(0, 150)}`);
        }
        if (res.status === 204 || (res.status === 200 && method === 'DELETE')) {
          return {}; // Handle empty responses for DELETE
        }
        return res.json();
      }

      // --- Login Logic ---
      async function login() {
        const username = $('username').value.trim();
        const repo = $('repo').value.trim();
        const token = $('token').value.trim();

        if (!username || !repo || !token) {
          return showStatus('loginStatus', 'Please fill all fields.', 'error');
        }

        githubConfig = { username, repo, token };
        $('loginBtn').disabled = true;
        $('loginBtn').textContent = 'Logging in...';

        try {
          await fetchGH('GET', ''); // Test connection
          localStorage.setItem('githubConfig', JSON.stringify(githubConfig));
          showStatus('loginStatus', 'Login successful!', 'success');
          setTimeout(showDashboard, 800);
        } catch (e) {
          showStatus('loginStatus', 'Login failed: ' + e.message, 'error');
        } finally {
          $('loginBtn').disabled = false;
          $('loginBtn').textContent = 'Login';
        }
      }

      // --- Post Management ---
      async function publishPost() {
        const title = $('postTitle').value.trim();
        const type = $('postType').value;
        const excerpt = $('postExcerpt').value.trim();
        const content = $('postContent').value.trim();
        const date = new Date().toISOString().split('T')[0];

        if (!title || !excerpt || !content) {
          return showStatus('postStatus', 'Please fill all fields.', 'error');
        }

        const btn = $('publishBtn');
        btn.disabled = true;
        btn.textContent = 'Publishing...';

        const filename = title.toLowerCase().replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '-') + '.md';
        const path = `posts/${filename}`;

        try {
          // 1. Create markdown file
          await fetchGH('PUT', `/contents/${path}`, {
            message: `Create post: ${title}`,
            content: btoa(unescape(encodeURIComponent(content)))
          });

          // 2. Update Posts.json
          const postsRes = await fetchGH('GET', '/contents/Posts.json');
          let posts = [];
          try { posts = JSON.parse(atob(postsRes.content)); } catch { posts = []; }
          if (!Array.isArray(posts)) posts = [];

          posts.unshift({ title, date, type, excerpt, file: path, likes: 0, views: 0 });

          await fetchGH('PUT', '/contents/Posts.json', {
            message: `Update Posts.json for: ${title}`,
            content: btoa(JSON.stringify(posts, null, 2)),
            sha: postsRes.sha
          });

          showStatus('postStatus', 'Post published successfully!', 'success');
          $('postTitle').value = '';
          $('postExcerpt').value = '';
          $('postContent').value = '';
          loadPosts();

        } catch (e) {
          showStatus('postStatus', 'Error publishing: ' + e.message, 'error');
        } finally {
          btn.disabled = false;
          btn.textContent = 'Publish Post';
        }
      }

      async function loadPosts() {
        try {
          const res = await fetchGH('GET', '/contents/Posts.json');
          const posts = JSON.parse(atob(res.content));
          const listEl = $('postsList');
          listEl.innerHTML = posts.map(p => `
            <div class="file-item">
              <span>${p.title}</span>
              <button onclick="deletePost('${p.file}')">Delete</button>
            </div>
          `).join('');
        } catch (e) {
          $('postsList').innerHTML = '<p>Could not load posts.</p>';
        }
      }

      async function deletePost(path) {
        if (!confirm('Are you sure you want to delete this post?')) return;

        try {
          // 1. Get file SHA to delete it
          const fileData = await fetchGH('GET', `/contents/${path}`);
          await fetchGH('DELETE', `/contents/${path}`, {
            message: `Delete post: ${path}`,
            sha: fileData.sha
          });

          // 2. Update Posts.json
          const postsRes = await fetchGH('GET', '/contents/Posts.json');
          const posts = JSON.parse(atob(postsRes.content));
          const updatedPosts = posts.filter(p => p.file !== path);

          await fetchGH('PUT', '/contents/Posts.json', {
            message: `Remove ${path} from Posts.json`,
            content: btoa(JSON.stringify(updatedPosts, null, 2)),
            sha: postsRes.sha
          });

          showStatus('manageStatus', 'Post deleted successfully!', 'success');
          loadPosts();

        } catch (e) {
          showStatus('manageStatus', 'Error deleting post: ' + e.message, 'error');
        }
      }

      // --- Tools ---
      async function checkAndFixPosts() {
        showStatus('toolStatus', 'Checking for missing files...', 'info');
        const resultsEl = $('fixResults');
        resultsEl.innerHTML = '';

        try {
          const postsRes = await fetchGH('GET', '/contents/Posts.json');
          const postsInJson = JSON.parse(atob(postsRes.content));

          const filesInRepoRes = await fetchGH('GET', '/contents/posts');
          const actualFiles = filesInRepoRes.map(f => `posts/${f.name}`);

          const missingFiles = postsInJson.filter(post => !actualFiles.includes(post.file));

          if (missingFiles.length === 0) {
            showStatus('toolStatus', 'No missing files found!', 'success');
          } else {
            showStatus('toolStatus', `Found ${missingFiles.length} posts with missing files.`, 'error');
            resultsEl.innerHTML = missingFiles.map(post => `
              <div class="file-item">
                <span>${post.title}</span>
                <button onclick="createMissingFile('${post.file}', '${post.title}', '${post.excerpt}')">Create File</button>
              </div>
            `).join('');
          }
        } catch (e) {
          showStatus('toolStatus', 'Error checking files: ' + e.message, 'error');
        }
      }

      async function createMissingFile(path, title, excerpt) {
        const content = `# ${title}\n\n> ${excerpt}\n\n_This file was created by the admin panel to fix a missing post. Please replace this with the full content._`;
        try {
          await fetchGH('PUT', `/contents/${path}`, {
            message: `Fix: Create missing file for ${title}`,
            content: btoa(unescape(encodeURIComponent(content)))
          });
          showStatus('toolStatus', `File ${path} created successfully!`, 'success');
          checkAndFixPosts(); // Re-run the check
        } catch (e) {
          showStatus('toolStatus', `Error creating file: ${e.message}`, 'error');
        }
      }

      // --- Event Listeners ---
      $('loginBtn').addEventListener('click', login);
      $('publishBtn').addEventListener('click', publishPost);
      $('fixBtn').addEventListener('click', checkAndFixPosts);

      // --- Auto-login if credentials are saved ---
      const saved = localStorage.getItem('githubConfig');
      if (saved) {
        githubConfig = JSON.parse(saved);
        $('username').value = githubConfig.username;
        $('repo').value = githubConfig.repo;
        showDashboard();
      }
    });
  </script>
</body>
</html>
