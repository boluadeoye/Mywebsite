<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Writer's Academy - Premium Lesson</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Lora:wght@400;700&family=Source+Sans+3:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dark-slate': '#2D3748',
                        'parchment': '#FFFFFF',
                        'page-bg': '#F9FAFB',
                        'gold-accent': '#D4AF37',
                        'body-text': '#374151',
                    },
                    fontFamily: {
                        'playfair': ['Playfair Display', 'serif'],
                        'lora': ['Lora', 'serif'],
                        'source-sans': ['Source Sans 3', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.0.0/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.2/anime.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        input:checked + .option-text-wrapper {
            border-color: #D4AF37;
            background-color: rgba(212, 175, 55, 0.1);
        }
        .difficulty-beginner {
            background-color: rgba(16, 185, 129, 0.1);
            color: #10B981;
        }
        .difficulty-intermediate {
            background-color: rgba(59, 130, 246, 0.1);
            color: #3B82F6;
        }
        .difficulty-advanced {
            background-color: rgba(212, 175, 55, 0.1);
            color: #D4AF37;
        }
    </style>
</head>
<body class="bg-page-bg text-body-text font-lora min-h-screen flex flex-col items-center p-8 md:p-12">
    <main id="lesson-card" class="w-full max-w-4xl mx-auto bg-parchment p-8 rounded-xl shadow-sm border border-gray-200">
        <div class="flex justify-between items-center mb-8">
            <a href="./premium-library.html" class="flex items-center gap-3">
                <svg class="h-10 w-10" viewBox="0 0 24 24">
                    <path d="M12 2 L2 22 H22 Z M12 6 L18.3 18 H5.7 Z" fill="#D4AF37"/>
                </svg>
            </a>
            <button id="logout-btn" class="font-source-sans bg-dark-slate text-parchment px-6 py-2 rounded-md hover:bg-dark-slate/90 transition">Logout</button>
        </div>
        <div id="lesson-container" class="space-y-16"></div>
    </main>
    <footer class="w-full mt-16 py-6 text-center text-gray-500">
        <p class="font-source-sans text-sm text-gray-400">© 2025 Boluadeoye • Crafted with passion</p>
        <p class="font-source-sans text-xs mt-2 text-gray-400 opacity-75">Built with Modern Web Craft</p>
    </footer>
    <script>
        // --- COMPLETE JAVASCRIPT LOGIC ---

        let currentLessonQuizzes = [];

        function saveProgress(lessonId) {
            let completed = JSON.parse(localStorage.getItem('academy_progress')) || [];
            if (!completed.includes(lessonId)) {
                completed.push(lessonId);
                localStorage.setItem('academy_progress', JSON.stringify(completed));
            }
        }

        function renderQuiz(quizzes) {
            const quizContainer = document.getElementById('quiz-container');
            if (!quizContainer) return;
            let quizHtml = '<div class="quiz-section space-y-12" style="opacity: 0;"><h3 class="text-3xl font-playfair text-dark-slate mb-6">Knowledge Check</h3>';
            quizzes.forEach((quiz, index) => {
                quizHtml += `<div id="quiz-block-${index}" class="p-8 bg-parchment rounded-xl shadow-sm border border-gray-200">`;
                if (quiz.type === 'multiple-choice' || quiz.type === 'sentence-correction') {
                    quizHtml += `<p class="font-source-sans text-lg font-semibold mb-6 text-body-text">${quiz.prompt}</p><div class="quiz-options space-y-4">`;
                    quiz.options.forEach((option) => { 
                        quizHtml += `<label class="block cursor-pointer"><input type="radio" name="quiz-${index}" value="${option}" class="sr-only"><span class="option-text-wrapper p-4 border border-gray-300 rounded-md block transition-colors duration-300 hover:border-gold-accent hover:bg-gold-accent/5 font-source-sans text-body-text">${option}</span></label>`;
                    });
                    quizHtml += `</div>`;
                } else if (quiz.type === 'fill-in-the-blank') {
                    quizHtml += `<p class="font-source-sans text-lg font-semibold mb-6 text-body-text">${quiz.prompt.replace('___', `<input type="text" class="border-b-2 border-gray-400 focus:border-gold-accent outline-none bg-transparent px-2 py-1 font-lora text-lg transition-colors" id="fill-in-${index}">`)}</p>`;
                }
                quizHtml += `<button class="mt-6 font-source-sans bg-dark-slate text-parchment px-6 py-3 rounded-md hover:bg-dark-slate/90 transition" onclick="checkAnswer(${index})">Check Answer</button>`;
                quizHtml += `<div id="feedback-${index}" class="mt-6"></div></div>`;
            });
            quizHtml += '</div>';
            quizContainer.innerHTML = quizHtml;

            // Add event listeners for instant visual feedback on selection
            quizzes.forEach((quiz, index) => {
                if (quiz.type === 'multiple-choice' || quiz.type === 'sentence-correction') {
                    // Visual feedback is handled by CSS on :checked
                }
            });

            anime({ targets: '.quiz-section', translateY: [50, 0], opacity: [0, 1], delay: 500, duration: 800, easing: 'easeOutCubic' });
        }

        function checkAnswer(quizIndex) {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');
            const quiz = currentLessonQuizzes[quizIndex];
            if (!quiz) return;
            
            const feedbackEl = document.getElementById(`feedback-${quizIndex}`);
            let isCorrect = false;

            if (quiz.type === 'multiple-choice' || quiz.type === 'sentence-correction') {
                const selected = document.querySelector(`input[name="quiz-${quizIndex}"]:checked`);
                if (selected && selected.value === quiz.answer) isCorrect = true;
            } else if (quiz.type === 'fill-in-the-blank') {
                const input = document.getElementById(`fill-in-${quizIndex}`);
                if (input && input.value.trim().toLowerCase() === quiz.answer.toLowerCase()) isCorrect = true;
            }
            
            const feedback = document.createElement('div');
            feedback.className = `p-4 rounded-md flex items-center space-x-3 font-source-sans transition-opacity duration-300 ${isCorrect ? 'bg-gold-accent/10 text-gold-accent' : 'bg-dark-slate/10 text-dark-slate'}`;
            feedback.innerHTML = `<i data-feather="${isCorrect ? 'check-circle' : 'x-circle'}"></i> <strong>${isCorrect ? 'Correct!' : 'Not quite.'}</strong> ${quiz.explanation || ''}`;
            feedbackEl.innerHTML = ''; 
            feedbackEl.appendChild(feedback); 
            feather.replace();
            document.querySelector(`#quiz-block-${quizIndex}`).querySelectorAll('button, input, textarea').forEach(el => el.disabled = true);
            if (isCorrect) saveProgress(id);

            // Animate feedback appearance
            anime({
                targets: feedback,
                opacity: [0, 1],
                translateY: [20, 0],
                duration: 500,
                easing: 'easeOutQuad'
            });
        }
        window.checkAnswer = checkAnswer;

        document.addEventListener('DOMContentLoaded', async () => {
            // Gatekeeper
            if (localStorage.getItem('academy_premium_token') !== 'true') {
                window.location.href = './login.html';
            }

            document.getElementById('logout-btn').addEventListener('click', () => { localStorage.removeItem('academy_premium_token'); window.location.href = './login.html'; });
            const container = document.getElementById('lesson-container');
            mermaid.initialize({ startOnLoad: false });
            try {
                const params = new URLSearchParams(window.location.search);
                const id = params.get('id');
                if (!id) throw new Error('No lesson ID provided.');
                
                const lessonsResponse = await fetch('data/all-lessons.json');
                if (!lessonsResponse.ok) throw new Error('Could not load lesson index.');
                const allLessons = await lessonsResponse.json();
                const lesson = allLessons.find(l => l.id === id);
                if (!lesson) throw new Error('Lesson not found.');

                currentLessonQuizzes = lesson.quizzes || [];
                document.title = `${lesson.title} - The Writer's Academy`;
                
                const mdResponse = await fetch(`lessons/${id}/content.md`);
                if (!mdResponse.ok) throw new Error('Could not load lesson content.');
                const mdContent = await mdResponse.text();
                
                const difficultyClass = `difficulty-${(lesson.difficulty || 'Beginner').toLowerCase()}`;
                container.innerHTML = `
                    <div class="lesson-header-container text-center space-y-6" style="opacity: 0;">
                        <h1 class="text-4xl font-playfair font-bold text-dark-slate">${lesson.title}</h1>
                        <p class="text-xl max-w-2xl mx-auto">${lesson.summary}</p>
                        <div class="inline-flex items-center px-4 py-2 rounded-full text-sm font-source-sans uppercase tracking-wide ${difficultyClass}"><i data-feather="bar-chart-2" class="mr-2"></i><span>${lesson.difficulty}</span></div>
                    </div>
                    <div id="lesson-content" class="prose prose-lg prose-headings:font-playfair prose-headings:text-dark-slate prose-p:text-body-text prose-li:text-body-text prose-blockquote:text-gray-600 prose-a:text-gold-accent prose-ul:list-disc prose-ul:pl-8 prose-ol:list-decimal prose-ol:pl-8 prose-li:my-4 leading-loose" style="opacity: 0;"></div>
                    <div id="quiz-container"></div>
                    <div id="lesson-spark" style="opacity: 0;"></div>
                `;

                document.getElementById('lesson-content').innerHTML = marked.parse(mdContent);
                if (lesson.quizzes && lesson.quizzes.length > 0) renderQuiz(lesson.quizzes);
                
                const sparkContainer = document.getElementById('lesson-spark');
                if (lesson.insightSpark) {
                    sparkContainer.innerHTML = `<div class="p-8 bg-dark-slate rounded-xl shadow-sm"><h3 class="text-2xl font-playfair text-gold-accent mb-4"><span class="mr-2">✨</span>Insight Spark</h3><p class="text-lg text-parchment">${lesson.insightSpark}</p></div>`;
                }

                mermaid.run({ querySelector: '.mermaid' });
                
                anime({
                  targets: '#lesson-spark',
                  translateY: [30, 0],
                  rotate: ['2deg', 0],
                  opacity: [0, 1],
                  delay: 1200,
                  duration: 1000,
                  easing: 'easeOutExpo'
                });

                // Additional animations for header and content
                anime({
                    targets: '.lesson-header-container',
                    opacity: [0, 1],
                    translateY: [50, 0],
                    duration: 800,
                    easing: 'easeOutCubic'
                });
                anime({
                    targets: '#lesson-content',
                    opacity: [0, 1],
                    translateY: [50, 0],
                    delay: 300,
                    duration: 800,
                    easing: 'easeOutCubic'
                });

            } catch (error) {
                console.error('Failed to load lesson:', error);
                container.innerHTML = `<p class="text-center font-source-sans text-dark-slate">${error.message}</p>`;
            } finally {
                feather.replace();
            }
        });
    </script>
</body>
</html>
