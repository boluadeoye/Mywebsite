<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rhythm & Meter Lab - The Writer's Academy</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Lora:wght@400;700&family=Source+Sans+3:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dark-slate': '#2D3748',
                        'parchment': '#FFFFFF',
                        'page-bg': '#F9FAFB',
                        'gold-accent': '#D4AF37',
                        'body-text': '#374151',
                    },
                    fontFamily: {
                        'playfair': ['Playfair Display', 'serif'],
                        'lora': ['Lora', 'serif'],
                        'source-sans': ['Source Sans 3', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        #waveform-path {
            stroke-width: 2;
        }
    </style>
</head>
<body class="bg-page-bg text-body-text font-lora min-h-screen flex flex-col items-center p-8 md:p-12">
    <header class="w-full max-w-7xl flex justify-end mb-8">
        <button id="logout-btn" class="font-source-sans bg-dark-slate text-parchment px-6 py-2 rounded-md hover:bg-dark-slate/90 transition">Logout</button>
    </header>
    <main class="w-full max-w-7xl mx-auto flex flex-col md:flex-row gap-8">
        <div id="left-panel" class="w-full md:w-1/4 bg-parchment p-8 rounded-xl shadow-sm border border-gray-200">
            <h2 class="text-2xl font-playfair text-dark-slate mb-6">Controls</h2>
            <div class="space-y-6">
                <div>
                    <label for="voice-select" class="block font-source-sans text-sm font-semibold mb-2">Voice</label>
                    <select id="voice-select" class="w-full p-3 border border-gray-300 rounded-md font-source-sans"></select>
                </div>
                <div>
                    <label for="rate-slider" class="block font-source-sans text-sm font-semibold mb-2">Rate <span id="rate-value" class="text-gold-accent">1.0x</span></label>
                    <input id="rate-slider" type="range" min="0.5" max="2" step="0.1" value="1" class="w-full">
                </div>
                <div>
                    <label for="pitch-slider" class="block font-source-sans text-sm font-semibold mb-2">Pitch <span id="pitch-value" class="text-gold-accent">1.0x</span></label>
                    <input id="pitch-slider" type="range" min="0.5" max="2" step="0.1" value="1" class="w-full">
                </div>
            </div>
        </div>
        <div id="center-panel" class="w-full md:w-1/2 flex flex-col gap-6">
            <h2 class="text-3xl font-playfair text-dark-slate text-center mb-4">The Canvas</h2>
            <textarea id="text-input" class="w-full h-48 p-4 border border-gray-300 rounded-md font-lora text-lg resize-vertical focus:border-gold-accent focus:outline-none transition-colors"></textarea>
            <div class="flex justify-center gap-4">
                <button id="play-button" class="font-source-sans bg-gold-accent text-parchment px-6 py-3 rounded-md hover:bg-gold-accent/90 transition flex items-center gap-2 disabled:opacity-50"><i data-feather="play"></i> Play</button>
                <button id="stop-button" class="font-source-sans bg-dark-slate text-parchment px-6 py-3 rounded-md hover:bg-dark-slate/90 transition flex items-center gap-2 disabled:opacity-50" disabled><i data-feather="stop-circle"></i> Stop</button>
            </div>
            <div class="waveform-container bg-parchment p-4 rounded-xl shadow-sm border border-gray-200">
                <svg id="waveform-svg" class="w-full h-32">
                    <path id="waveform-path" stroke="#D4AF37" fill="none"></path>
                </svg>
            </div>
        </div>
        <div id="right-panel" class="w-full md:w-1/4 bg-parchment p-8 rounded-xl shadow-sm border border-gray-200">
            <h2 class="text-2xl font-playfair text-dark-slate mb-6">Analysis</h2>
            <div id="text-display" class="font-lora text-lg mb-8 min-h-48 p-4 border border-gray-200 rounded-md bg-page-bg overflow-auto"></div>
            <div class="metrics space-y-4 font-source-sans">
                <p class="flex justify-between"><span>Word Count:</span> <span id="word-count" class="text-gold-accent font-semibold">0</span></p>
                <p class="flex justify-between"><span>Sentence Count:</span> <span id="sentence-count" class="text-gold-accent font-semibold">0</span></p>
                <p class="flex justify-between"><span>Est. Reading Time:</span> <span id="reading-time" class="text-gold-accent font-semibold">0s</span></p>
                <p class="flex justify-between"><span>Syllables/Word:</span> <span id="syllables-word" class="text-gold-accent font-semibold">0.0</span></p>
            </div>
        </div>
    </main>
    <script>
        // --- COMPLETE JAVASCRIPT LOGIC FOR RHYTHM & METER LAB ---

        // Gatekeeper: Redirects if not logged in.
        if (localStorage.getItem('academy_premium_token') !== 'true') {
            window.location.href = './login.html';
        }

        document.addEventListener('DOMContentLoaded', () => {
            feather.replace({ 'stroke-width': 2 });

            // --- DOM ELEMENT REFERENCES ---
            const textInput = document.getElementById('text-input');
            const textDisplay = document.getElementById('text-display');
            const playButton = document.getElementById('play-button');
            const stopButton = document.getElementById('stop-button');
            const rateSlider = document.getElementById('rate-slider');
            const pitchSlider = document.getElementById('pitch-slider');
            const rateValue = document.getElementById('rate-value');
            const pitchValue = document.getElementById('pitch-value');
            const voiceSelect = document.getElementById('voice-select');
            const waveformPath = document.getElementById('waveform-path');
            const svg = document.getElementById('waveform-svg');
            
            let utterance = null;
            let voices = [];
            let animationFrameId = null;

            // --- CORE FUNCTIONS ---

            // Populates the voice selection dropdown.
            function populateVoiceList() {
                voices = speechSynthesis.getVoices();
                voiceSelect.innerHTML = '';
                voices.forEach((voice) => {
                    if(voice.lang.startsWith('en')) { // Only show English voices
                        const option = document.createElement('option');
                        option.textContent = `${voice.name} (${voice.lang})`;
                        option.setAttribute('data-name', voice.name);
                        voiceSelect.appendChild(option);
                    }
                });
            }

            // Calculates and displays real-time text metrics.
            function calculateMetrics() {
                const text = textInput.value;
                const words = text.trim().split(/\s+/).filter(w => w.length > 0);
                const wordCount = words.length;
                const sentences = text.match(/[\w|\)][.?!](\s|$)/g) || [];
                const sentenceCount = sentences.length || (wordCount > 0 ? 1 : 0);
                
                const syllableRegex = /[^aeiouy]*[aeiouy]+(?:[^aeiouy]*$|[^aeiouy](?=[^aeiouy]))?/gi;
                const totalSyllables = words.reduce((acc, word) => acc + (word.match(syllableRegex) || []).length, 0);
                
                document.getElementById('word-count').textContent = wordCount;
                document.getElementById('sentence-count').textContent = sentenceCount;
                const readingTime = Math.round((wordCount / 200) * 60); // Assumes 200 WPM
                document.getElementById('reading-time').textContent = `${readingTime}s`;
                document.getElementById('syllables-word').textContent = wordCount > 0 ? (totalSyllables / wordCount).toFixed(1) : '0.0';
            }

            // Stops playback and resets the UI.
            function stopPlayback() {
                if (speechSynthesis.speaking) speechSynthesis.cancel();
                if (animationFrameId) cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
                resetUI();
            }

            function resetUI() {
                playButton.disabled = false;
                stopButton.disabled = true;
                playButton.innerHTML = '<i data-feather="play"></i> Play';
                textDisplay.innerHTML = '';
                feather.replace({ 'stroke-width': 2 });
                waveformPath.setAttribute('d', `M0,${svg.clientHeight / 2} L${svg.clientWidth},${svg.clientHeight / 2}`);
            }

            // Main function to initiate speech.
            function playText() {
                if (speechSynthesis.speaking) return;
                const text = textInput.value;
                if (!text.trim()) return alert('Please enter some text.');
                
                stopPlayback();
                
                utterance = new SpeechSynthesisUtterance(text);
                const selectedVoiceName = voiceSelect.selectedOptions[0]?.getAttribute('data-name');
                const selectedVoice = voices.find(voice => voice.name === selectedVoiceName);
                if (selectedVoice) utterance.voice = selectedVoice;
                
                utterance.rate = rateSlider.value;
                utterance.pitch = pitchSlider.value;

                utterance.onstart = () => {
                    playButton.disabled = true;
                    stopButton.disabled = false;
                    drawWaveform(); // Start the visualization
                };
                
                utterance.onend = stopPlayback;
                utterance.onerror = (e) => { console.error('Speech synthesis error:', e); stopPlayback(); };

                utterance.onboundary = (event) => {
                    const { charIndex, charLength } = event;
                    const before = text.substring(0, charIndex);
                    const word = text.substring(charIndex, charIndex + charLength);
                    const after = text.substring(charIndex + charLength);
                    textDisplay.innerHTML = `${before}<span class="bg-gold-accent/20 rounded px-1">${word}</span>${after}`;
                };

                speechSynthesis.speak(utterance);
            }

            // Renders a dynamic, synchronized waveform simulation.
            function drawWaveform() {
                if (!speechSynthesis.speaking) return;
                
                const width = svg.clientWidth;
                const height = svg.clientHeight;
                const midY = height / 2;
                let pathData = `M 0,${midY}`;
                const segments = 20;

                for (let i = 0; i <= segments; i++) {
                    const x = (width / segments) * i;
                    const randomAmplitude = Math.random() * (height * 0.8) + (height * 0.1);
                    const y = midY - (randomAmplitude - midY) * (Math.random() > 0.5 ? 1 : -1) * 0.5;
                    pathData += ` T ${x},${y}`;
                }
                waveformPath.setAttribute('d', pathData);
                
                animationFrameId = requestAnimationFrame(drawWaveform);
            }

            // --- INITIALIZATION & EVENT LISTENERS ---
            
            // Populate voices
            populateVoiceList();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = populateVoiceList;
            }

            // Set initial UI states and listeners
            textInput.addEventListener('input', calculateMetrics);
            rateSlider.addEventListener('input', () => rateValue.textContent = `${parseFloat(rateSlider.value).toFixed(1)}x`);
            pitchSlider.addEventListener('input', () => pitchValue.textContent = `${parseFloat(pitchSlider.value).toFixed(1)}x`);
            playButton.addEventListener('click', playText);
            stopButton.addEventListener('click', stopPlayback);

            calculateMetrics();
            resetUI();
        });
    </script>
</body>
</html>
