<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Craft Forge — Boluadeoye</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f172a; --panel: #111a2e; --ink: #e5eefc; --muted: #94a3b8;
    --orange: #f59e0b; --serif: 'Playfair Display', Georgia, serif; --sans-serif: 'Inter', system-ui, sans-serif;
    --transition: cubic-bezier(0.4, 0, 0.2, 1);
  }
  body.forge-theme {
    --forge-bg: #1e1e1e; --forge-ink: #e0e0e0; --forge-muted: #888888;
    --forge-panel: #2a2a2a; --forge-border: #444444; --forge-accent: #d4af37;
    --forge-accent-light: #ffdead;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { height: 100%; scroll-behavior: smooth; }
  body { background: var(--bg); color: var(--ink); font: 16px/1.7 var(--sans-serif); }
  body.forge-theme { background: var(--forge-bg); color: var(--forge-ink); }
  .wrap { max-width: 1200px; margin: 0 auto; padding: 0 1.5rem; }
  header { position: sticky; top: 0; z-index: 100; background: rgba(15,23,42,.85); backdrop-filter: blur(8px); border-bottom: 1px solid rgba(245,158,11,.15); }
  .header-row { display: flex; align-items: center; justify-content: space-between; min-height: 80px; position: relative; padding: 0 1rem; }
  .brand { display: flex; flex-direction: column; align-items: center; position: absolute; left: 50%; top: -20px; transform: translateX(-50%); }
  .brand-logo { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin-bottom: -35px; }
  a { color: inherit; text-decoration: none; } .brand h1 { font-family: var(--serif); font-size: 1.62rem; color: var(--ink); }
  footer { background: var(--panel); border-top: 1px solid rgba(245, 158, 11, .2); color: var(--muted); text-align: center; font-size: 0.88rem; padding: 2rem 0; margin-top: 4rem; }
  .forge-container { display: grid; grid-template-columns: 300px 1fr; gap: 2rem; padding: 3rem 0; }
  .forge-sidebar { position: sticky; top: 100px; height: calc(100vh - 120px); }
  .forge-main { display: flex; flex-direction: column; gap: 1.5rem; }
  .sidebar-section { background: var(--forge-panel); border: 1px solid var(--forge-border); border-radius: 12px; padding: 1.25rem; margin-bottom: 1rem; }
  .sidebar-section h3 { font-family: var(--serif); font-size: 1.2rem; margin-bottom: 1rem; color: var(--forge-accent); border-bottom: 1px solid var(--forge-border); padding-bottom: 0.75rem; }
  #texts-list, #lenses-list { display: flex; flex-direction: column; gap: 0.5rem; }
  .text-button { width: 100%; background: none; border: 1px solid transparent; color: var(--forge-ink); padding: 0.75rem 1rem; border-radius: 8px; text-align: left; cursor: pointer; transition: all 0.2s var(--transition); }
  .text-button:hover { background: rgba(212, 175, 55, 0.1); }
  .text-button.active { background: var(--forge-accent); color: #1e1e1e; font-weight: 700; }
  .text-button span { display: block; font-size: 0.8rem; opacity: 0.7; }
  .lens-button { width: 100%; background: rgba(255,255,255,0.05); border: 1px solid var(--forge-border); color: var(--forge-ink); padding: 0.75rem 1rem; border-radius: 8px; text-align: left; cursor: pointer; transition: all 0.2s var(--transition); font-weight: 700; }
  .lens-button:hover { border-color: var(--forge-accent); transform: scale(1.02); }
  .lens-button.active { background: var(--forge-accent-light); color: #1e1e1e; border-color: var(--forge-accent); }
  .excerpt-panel { background: var(--forge-panel); border: 1px solid var(--forge-border); border-radius: 12px; padding: 2rem; }
  .excerpt-text { font-family: var(--serif); font-size: 1.3rem; line-height: 1.8; color: var(--forge-muted); white-space: pre-wrap; transition: color 0.3s; }
  .excerpt-text mark { background: rgba(212, 175, 55, 0.3); color: var(--forge-accent-light); padding: 0.1em 0.2em; border-radius: 4px; animation: fadeIn 0.5s; }
  .analyst-note-panel { background: transparent; border: 1px solid var(--forge-border); border-left: 4px solid var(--forge-accent); border-radius: 0 12px 12px 0; padding: 1.5rem; opacity: 0; transform: translateY(10px); transition: opacity 0.4s var(--transition), transform 0.4s var(--transition); will-change: opacity, transform; }
  .analyst-note-panel.visible { opacity: 1; transform: translateY(0); }
  .analyst-note-panel p { margin: 0; font-size: 1rem; line-height: 1.7; }
  .loading-view, .error-view { text-align: center; padding: 4rem; } .error-view { color: #e74c3c; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  @media (max-width: 900px) { .forge-container { grid-template-columns: 1fr; } .forge-sidebar { position: static; height: auto; } }
</style>
</head>
<body class="forge-theme">
  <header id="header"><div class="wrap header-row"><a class="brand" href="./"><img src="images/Logo.png" alt="Boluadeoye Logo" class="brand-logo"><h1>Boluadeoye</h1></a></div></header>

  <main class="wrap">
    <div id="loading-view" class="loading-view">Loading The Forge...</div>
    <div id="error-view" class="error-view" style="display:none;"></div>
    <div id="forge-container" class="forge-container" style="display:none;">
      <aside class="forge-sidebar">
        <div class="sidebar-section">
          <h3 aria-live="polite">1. Select a Text</h3>
          <div id="texts-list" role="radiogroup"></div>
        </div>
        <div class="sidebar-section">
          <h3 aria-live="polite">2. Apply a Lens</h3>
          <div id="lenses-list"></div>
        </div>
      </aside>
      <main class="forge-main">
        <div class="excerpt-panel">
          <p id="excerpt-text" class="excerpt-text" aria-live="polite"></p>
        </div>
        <div id="analyst-note-panel" class="analyst-note-panel" role="alert">
          <p id="analyst-note-text"></p>
        </div>
      </main>
    </div>
  </main>

  <footer><div class="wrap"><p>© 2025 Boluadeoye • Crafted with passion</p></div></footer>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const loadingView = document.getElementById('loading-view');
      const errorView = document.getElementById('error-view');
      const forgeContainer = document.getElementById('forge-container');
      const textsListEl = document.getElementById('texts-list');
      const lensesListEl = document.getElementById('lenses-list');
      const excerptTextEl = document.getElementById('excerpt-text');
      const notePanel = document.getElementById('analyst-note-panel');
      const noteTextEl = document.getElementById('analyst-note-text');

      let atlasIndex = {};
      let textsCache = new Map();
      let activeTextId = null;
      let activeLensId = null;

      function showError(message) {
        loadingView.style.display = 'none';
        forgeContainer.style.display = 'none';
        errorView.style.display = 'block';
        errorView.textContent = message;
      }

      function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      }

      async function initForge() {
        try {
          const res = await fetch('./atlas-index.json', { cache: 'no-store' });
          if (!res.ok) throw new Error('Could not load the Atlas index.');
          atlasIndex = await res.json();
          
          if (atlasIndex.texts && atlasIndex.texts.length > 0) {
            populateTextsList();
            loadingView.style.display = 'none';
            forgeContainer.style.display = 'grid';
            await selectText(atlasIndex.texts[0].id);
          } else {
            throw new Error('Atlas index is empty.');
          }
        } catch (error) {
          showError(error.message);
        }
      }

      function populateTextsList() {
        textsListEl.innerHTML = atlasIndex.texts.map(text => `
          <button class="text-button" role="radio" aria-checked="false" data-id="${text.id}" aria-label="Select text: ${text.title} by ${text.author}">
            ${text.title} <span>by ${text.author}</span>
          </button>
        `).join('');
        textsListEl.addEventListener('click', e => {
          const button = e.target.closest('.text-button');
          if (button) selectText(button.dataset.id);
        });
      }

      async function selectText(textId) {
        if (activeTextId === textId) return;
        activeTextId = textId;
        activeLensId = null;

        document.querySelectorAll('.text-button').forEach(btn => {
          const isActive = btn.dataset.id === textId;
          btn.classList.toggle('active', isActive);
          btn.setAttribute('aria-checked', isActive);
        });
        
        try {
          let textData = textsCache.get(textId);
          if (!textData) {
            const res = await fetch(`./texts/${textId}.json`, { cache: 'no-store' });
            if (!res.ok) throw new Error(`Could not load text: ${textId}`);
            textData = await res.json();
            textsCache.set(textId, textData);
          }
          
          renderExcerpt(textData);
          populateLenses(textData.lenses);
          
          const firstLensId = Object.keys(textData.lenses)[0];
          if (firstLensId) selectLens(firstLensId);

        } catch (error) {
          showError(error.message);
        }
      }

      function populateLenses(lenses) {
        lensesListEl.innerHTML = Object.keys(lenses).map(lensId => `
          <button class="lens-button" data-id="${lensId}" aria-label="Apply lens: ${lenses[lensId].lens_name}">
            ${lenses[lensId].lens_name}
          </button>
        `).join('');
        lensesListEl.addEventListener('click', e => {
          const button = e.target.closest('.lens-button');
          if (button) {
            const lensId = button.dataset.id;
            selectLens(activeLensId === lensId ? null : lensId);
          }
        });
      }

      function selectLens(lensId) {
        activeLensId = lensId;
        const textData = textsCache.get(activeTextId);
        if (textData) renderExcerpt(textData, lensId);
      }
      
      function renderExcerpt(textData, lensId = null) {
          let content = textData.excerpt;
          notePanel.classList.remove('visible');
          document.querySelectorAll('.lens-button').forEach(btn => btn.classList.toggle('active', btn.dataset.id === lensId));
          
          if (lensId && textData.lenses[lensId]) {
              const lensData = textData.lenses[lensId];
              lensData.highlights.forEach(h => {
                  const pattern = new RegExp(escapeRegExp(h.pattern), 'g');
                  content = content.replace(pattern, `<mark>$&</mark>`);
              });
              noteTextEl.textContent = lensData.note;
              notePanel.classList.add('visible');
          }
          excerptTextEl.innerHTML = content.replace(/\n/g, '<br>');
      }

      initForge();
    });
  </script>
</body>
  </html>
