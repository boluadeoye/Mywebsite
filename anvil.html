<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Anvil - The Writer's Foundry</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f5f5dc;
            --panel: #ffffff;
            --ink: #2c3e50;
            --muted: #596a7a;
            --accent: #800000;
            --border-color: #dcd8cd;
            --accent-light: #fdfcf7;
        }

        /* --- Global Styles & Typography --- */
        body {
            background-color: var(--bg);
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            color: var(--ink);
            margin: 0;
            padding: 80px 1rem 2rem 1rem;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            transition: background-color 0.5s ease;
        }
        h1, h2, h3, h4 {
            font-family: 'Playfair Display', serif;
            font-weight: 800;
            color: var(--ink);
        }

        /* --- Unified Navigation Bar --- */
        .foundry-nav {
            position: fixed; top: 0; left: 0; width: 100%;
            background-color: var(--panel); box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-bottom: 1px solid var(--border-color); display: flex;
            justify-content: center; align-items: center; padding: 0 1rem;
            height: 60px; z-index: 1000; transition: opacity 0.5s ease;
        }
        .foundry-nav-links { display: flex; gap: 2rem; }
        .foundry-nav-links a { text-decoration: none; color: var(--muted); font-weight: 600; font-size: 1rem; padding: 0.5rem 0; border-bottom: 2px solid transparent; transition: color 0.2s ease, border-color 0.2s ease; }
        .foundry-nav-links a:hover { color: var(--ink); }
        .foundry-nav-links a.active { color: var(--accent); border-bottom-color: var(--accent); }

        /* --- Main Anvil Layout --- */
        .anvil-container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }

        /* --- Prompt Box --- */
        .prompt-box { border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 2rem; background-color: var(--panel); transition: opacity 0.5s ease; }
        .prompt-header { padding: 1rem 1.5rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); }
        .prompt-header h2 { margin: 0; font-size: 1.5rem; }
        .prompt-toggle { font-size: 1.5rem; color: var(--muted); transition: transform 0.3s ease; }
        .prompt-content { padding: 0 1.5rem; max-height: 0; overflow: hidden; transition: max-height 0.5s ease, padding 0.5s ease; }
        .prompt-box.open .prompt-content { max-height: 1000px; padding: 1.5rem; }
        .prompt-box.open .prompt-toggle { transform: rotate(180deg); }
        .prompt-content h3 { text-transform: uppercase; letter-spacing: 1px; font-size: 0.9rem; margin: 1rem 0 0.5rem 0; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color); }
        .prompt-content p { font-size: 1rem; line-height: 1.6; color: var(--muted); margin: 0 0 1rem 0; }
        .prompt-content strong { color: var(--ink); font-weight: 700; }
        #empty-prompt { text-align: center; padding: 2rem; color: var(--muted); }
        #empty-prompt a { color: var(--accent); }

        /* --- Text Editor --- */
        .editor-wrapper { position: relative; }
        #editor {
            width: 100%;
            min-height: 70vh;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 2rem;
            font-size: 1.2rem;
            line-height: 1.7;
            background-color: var(--panel);
            box-sizing: border-box;
            resize: vertical;
            transition: all 0.5s ease;
        }
        #editor:focus { outline: 2px solid var(--accent); border-color: var(--accent); }

        /* --- Toolbar & Stats --- */
        .anvil-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1rem;
            padding: 1rem;
            background-color: var(--panel);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            transition: opacity 0.5s ease;
        }
        .toolbar-group { display: flex; gap: 0.5rem; align-items: center; }
        .toolbar-btn { background: none; border: 1px solid var(--border-color); border-radius: 6px; padding: 0.5rem 1rem; cursor: pointer; font-weight: 600; transition: all 0.2s ease; }
        .toolbar-btn:hover { background-color: var(--accent-light); border-color: var(--muted); }
        #stats { color: var(--muted); font-weight: 600; font-size: 0.9rem; }

        /* --- Sensory Palette Sidebar --- */
        #sensory-sidebar {
            position: fixed;
            top: 0;
            right: -350px; /* Initially hidden */
            width: 320px;
            height: 100%;
            background-color: var(--panel);
            box-shadow: -5px 0 20px rgba(0,0,0,0.1);
            border-left: 1px solid var(--border-color);
            padding: 1.5rem;
            padding-top: 70px; /* Space for nav */
            box-sizing: border-box;
            transition: right 0.4s ease;
            z-index: 999;
        }
        #sensory-sidebar.open { right: 0; }
        #sensory-sidebar h3 { margin: 0 0 1rem 0; }
        #sensory-sidebar ul { list-style: none; padding: 0; margin: 0; }
        #sensory-sidebar li { margin-bottom: 1.5rem; }
        #sensory-sidebar li strong { display: block; text-transform: uppercase; font-size: 0.9rem; margin-bottom: 0.25rem; }
        #sensory-sidebar li span { color: var(--muted); line-height: 1.5; }
        #close-sidebar { position: absolute; top: 70px; right: 1.5rem; font-size: 2rem; background: none; border: none; cursor: pointer; color: var(--muted); }

        /* --- Thesaurus Popup --- */
        #thesaurus-popup {
            position: absolute;
            background-color: var(--panel);
            border: 1px solid var(--border-color);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-radius: 8px;
            padding: 1rem;
            max-width: 250px;
            z-index: 1001;
            display: none;
        }
        #thesaurus-popup h4 { margin: 0 0 0.5rem 0; font-size: 1rem; }
        #thesaurus-synonyms { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        #thesaurus-synonyms span { background-color: var(--accent-light); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.9rem; cursor: pointer; }
        #thesaurus-synonyms span:hover { background-color: var(--border-color); }
        #thesaurus-popup .loading { text-align: center; color: var(--muted); }

        /* --- Zen Mode --- */
        body.zen-mode { background-color: var(--accent-light); }
        body.zen-mode .foundry-nav,
        body.zen-mode .prompt-box,
        body.zen-mode .anvil-toolbar { opacity: 0; pointer-events: none; }
        body.zen-mode #editor { border-color: transparent; box-shadow: 0 0 30px rgba(0,0,0,0.05); }

        @media (max-width: 768px) {
            #sensory-sidebar { width: 280px; right: -300px; }
        }
    </style>
</head>
<body>
    
    <nav class="foundry-nav">
        <div class="foundry-nav-links">
            <a href="lab.html">The Forge</a>
            <a href="anvil.html" class="active">The Anvil</a>
            <a href="journal.html">The Journal</a>
        </div>
    </nav>

    <main class="anvil-container">
        <div class="prompt-box" id="prompt-box">
            <div class="prompt-header" id="prompt-header">
                <h2>Your Forged Idea</h2>
                <span class="prompt-toggle">&or;</span>
            </div>
            <div class="prompt-content" id="prompt-content">
                </div>
        </div>
        
        <div class="editor-wrapper">
            <textarea id="editor" placeholder="The anvil is ready. Forge your story..."></textarea>
            <div id="thesaurus-popup"></div>
        </div>

        <div class="anvil-toolbar">
            <div class="toolbar-group">
                <button class="toolbar-btn" id="zen-btn">Zen Mode</button>
                <button class="toolbar-btn" id="palette-btn">Palette</button>
            </div>
            <div id="stats">0 words / 0 characters</div>
            <div class="toolbar-group">
                <button class="toolbar-btn" id="export-txt">Export .txt</button>
                <button class="toolbar-btn" id="export-md">Export .md</button>
            </div>
        </div>
    </main>

    <aside id="sensory-sidebar">
        <button id="close-sidebar">&times;</button>
        <h3>Sensory Palette</h3>
        <ul id="sensory-list">
            </ul>
    </aside>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM ELEMENTS ---
        const editor = document.getElementById('editor');
        const promptBox = document.getElementById('prompt-box');
        const promptHeader = document.getElementById('prompt-header');
        const promptContent = document.getElementById('prompt-content');
        const statsEl = document.getElementById('stats');
        const zenBtn = document.getElementById('zen-btn');
        const paletteBtn = document.getElementById('palette-btn');
        const sensorySidebar = document.getElementById('sensory-sidebar');
        const closeSidebarBtn = document.getElementById('close-sidebar');
        const sensoryList = document.getElementById('sensory-list');
        const thesaurusPopup = document.getElementById('thesaurus-popup');
        const exportTxtBtn = document.getElementById('export-txt');
        const exportMdBtn = document.getElementById('export-md');
        
        let currentIdea = null;
        let draftKey = 'foundry-draft-default';

        // --- INITIALIZATION ---
        function initializeAnvil() {
            loadIdeaFromStorage();
            if (currentIdea) {
                draftKey = `foundry-draft-${currentIdea.setting.name.replace(/\s+/g, '-')}`;
                populatePrompt();
                populateSensoryPalette();
            } else {
                displayEmptyPrompt();
            }
            loadDraft();
            updateStats();
            setupEventListeners();
        }

        // --- DATA HANDLING ---
        function loadIdeaFromStorage() {
            const ideaJSON = localStorage.getItem('foundry-current-idea');
            if (ideaJSON) {
                currentIdea = JSON.parse(ideaJSON);
            }
        }

        function loadDraft() {
            const savedText = localStorage.getItem(draftKey);
            if (savedText) {
                editor.value = savedText;
            }
        }

        function saveDraft() {
            localStorage.setItem(draftKey, editor.value);
        }

        function populatePrompt() {
            promptContent.innerHTML = `
                <h3>Logline</h3>
                <p>${currentIdea.logline}</p>
                <h3>Deep-Dive Question</h3>
                <p>${currentIdea.deepDive}</p>
            `;
        }

        function displayEmptyPrompt() {
            promptContent.innerHTML = `
                <div id="empty-prompt">
                    <p>No idea loaded.</p>
                    <a href="lab.html">Forge a new idea in the Lab &rarr;</a>
                </div>
            `;
            promptBox.classList.add('open');
            paletteBtn.disabled = true;
            paletteBtn.style.opacity = 0.5;
        }

        function populateSensoryPalette() {
            const palette = currentIdea.setting.sensory_palette;
            sensoryList.innerHTML = `
                <li><strong>Sight</strong><span>${palette.sight}</span></li>
                <li><strong>Sound</strong><span>${palette.sound}</span></li>
                <li><strong>Smell</strong><span>${palette.smell}</span></li>
            `;
        }
        
        // --- EDITOR FUNCTIONALITY ---
        function updateStats() {
            const text = editor.value;
            const wordCount = text.trim().split(/\s+/).filter(word => word.length > 0).length;
            const charCount = text.length;
            statsEl.textContent = `${wordCount} words / ${charCount} characters`;
        }

        function toggleZenMode() {
            document.body.classList.toggle('zen-mode');
        }

        function toggleSensoryPalette() {
            sensorySidebar.classList.toggle('open');
        }

        function exportToFile(filename, content) {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // --- THESAURUS ---
        async function showThesaurus(word, x, y) {
            thesaurusPopup.style.display = 'block';
            thesaurusPopup.style.left = `${x}px`;
            thesaurusPopup.style.top = `${y}px`;
            thesaurusPopup.innerHTML = `<h4>Synonyms for "${word}"</h4><div class="loading">Loading...</div>`;

            try {
                const response = await fetch(`https://api.datamuse.com/words?rel_syn=${word}`);
                const data = await response.json();
                
                let content;
                if (data.length > 0) {
                    content = `<div id="thesaurus-synonyms">${data.slice(0, 10).map(item => `<span>${item.word}</span>`).join('')}</div>`;
                } else {
                    content = `<div class="loading">No synonyms found.</div>`;
                }
                thesaurusPopup.innerHTML = `<h4>Synonyms for "${word}"</h4>${content}`;

            } catch (error) {
                console.error('Thesaurus API error:', error);
                thesaurusPopup.innerHTML = `<h4>Error</h4><div class="loading">Could not fetch data.</div>`;
            }
        }

        function replaceSelectedText(replacementText) {
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            editor.value = editor.value.substring(0, start) + replacementText + editor.value.substring(end);
            editor.focus();
            editor.selectionEnd = start + replacementText.length;
        }

        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            // Auto-save and stats update
            let saveTimeout;
            editor.addEventListener('input', () => {
                updateStats();
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(saveDraft, 500); // Save 500ms after user stops typing
            });

            // UI Toggles
            promptHeader.addEventListener('click', () => promptBox.classList.toggle('open'));
            zenBtn.addEventListener('click', toggleZenMode);
            paletteBtn.addEventListener('click', toggleSensoryPalette);
            closeSidebarBtn.addEventListener('click', toggleSensoryPalette);

            // Export buttons
            exportTxtBtn.addEventListener('click', () => exportToFile('foundry-draft.txt', editor.value));
            exportMdBtn.addEventListener('click', () => exportToFile('foundry-draft.md', editor.value));

            // Thesaurus on double-click
            editor.addEventListener('dblclick', (e) => {
                const selectedText = window.getSelection().toString().trim();
                if (selectedText.length > 1 && !selectedText.includes(' ')) {
                    showThesaurus(selectedText, e.pageX, e.pageY);
                }
            });

            // Clicking outside the thesaurus popup closes it
            document.addEventListener('click', (e) => {
                if (!thesaurusPopup.contains(e.target) && e.target !== editor) {
                    thesaurusPopup.style.display = 'none';
                }
            });

            // Replace word when a synonym is clicked
            thesaurusPopup.addEventListener('click', (e) => {
                if(e.target.tagName === 'SPAN') {
                    replaceSelectedText(e.target.textContent);
                    thesaurusPopup.style.display = 'none';
                }
            });
        }

        // --- START THE APPLICATION ---
        initializeAnvil();
    });
    </script>
</body>
</html>
