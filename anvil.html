<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Anvil - The Writer's Foundry</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            /* The Modern Aesthetic Palette */
            --bg-light-gray: #F4F7FA;
            --panel-white: #FFFFFF;
            --primary-blue: #0052CC;
            --hover-blue: #0065FF;
            --text-dark: #172B4D;
            --text-muted: #6B778C;
            --border-color: #DFE1E6;
            
            /* Timing Function & Spacing Grid */
            --transition-curve: cubic-bezier(0.4, 0, 0.2, 1);
            --space-8: 8px;
            --space-12: 12px;
            --space-16: 16px;
            --space-24: 24px;
            --space-32: 32px;
        }

        /* --- Global Styles & Typography --- */
        *, *::before, *::after { box-sizing: border-box; }

        body {
            background-color: var(--bg-light-gray);
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            font-weight: 400;
            color: var(--text-dark);
            margin: 0;
            padding: calc(64px + var(--space-32)) var(--space-16) var(--space-32) var(--space-16);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background-color 0.4s var(--transition-curve);
        }

        /* --- Unified Navigation Bar --- */
        .foundry-nav {
            position: fixed; top: 0; left: 0; width: 100%;
            background-color: var(--panel-white);
            box-shadow: 0 2px 8px rgba(23, 43, 77, 0.05);
            border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 var(--space-24); height: 64px; z-index: 1000;
            transition: opacity 0.4s var(--transition-curve), transform 0.4s var(--transition-curve);
        }
        .nav-brand {
            font-weight: 800; font-size: 1.2rem;
            color: var(--text-dark); text-decoration: none;
        }
        .nav-links { display: flex; gap: var(--space-24); }
        .nav-links a {
            text-decoration: none; color: var(--text-muted);
            font-weight: 700; font-size: 1rem;
            padding: var(--space-8) 0;
            border-bottom: 2px solid transparent;
            transition: color 0.2s var(--transition-curve);
        }
        .nav-links a:hover { color: var(--text-dark); }
        .nav-links a.active { color: var(--primary-blue); border-bottom-color: var(--primary-blue); }

        /* --- Main Anvil Layout --- */
        .anvil-wrap {
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
        }

        .tool-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--space-16);
            padding: var(--space-12) var(--space-16);
            background-color: var(--panel-white);
            border: 1px solid var(--border-color);
            border-radius: var(--space-12);
            margin-bottom: var(--space-24);
            transition: opacity 0.4s var(--transition-curve), transform 0.4s var(--transition-curve);
        }
        .tool-group { display: flex; gap: var(--space-8); align-items: center; }
        .tool-btn {
            background-color: transparent; border: 1px solid transparent;
            border-radius: 8px; padding: var(--space-8) var(--space-12);
            cursor: pointer; font-weight: 700; font-size: 0.9rem;
            color: var(--text-muted);
            display: flex; align-items: center; gap: var(--space-8);
            transition: all 0.2s var(--transition-curve);
        }
        .tool-btn svg { width: 16px; height: 16px; stroke: var(--text-muted); transition: stroke 0.2s var(--transition-curve); }
        .tool-btn:hover { background-color: var(--bg-light-gray); color: var(--text-dark); }
        .tool-btn:hover svg { stroke: var(--text-dark); }
        .stats-display { color: var(--text-muted); font-weight: 700; font-size: 0.9rem; text-align: center; }

        /* --- Prompt Box --- */
        .prompt-box {
            border: 1px solid var(--border-color);
            border-radius: var(--space-12);
            margin-bottom: var(--space-24);
            background-color: var(--panel-white);
            transition: opacity 0.4s var(--transition-curve), transform 0.4s var(--transition-curve);
        }
        .prompt-box summary {
            padding: var(--space-16) var(--space-24);
            cursor: pointer;
            font-weight: 800; font-size: 1.3rem; color: var(--text-dark);
            display: flex; justify-content: space-between; align-items: center;
            outline-color: var(--hover-blue);
        }
        .prompt-content {
            padding: 0 var(--space-24) var(--space-24) var(--space-24);
            border-top: 1px solid var(--border-color);
        }
        .prompt-content h3 {
            font-weight: 700; text-transform: uppercase;
            letter-spacing: 0.5px; font-size: 1rem;
            margin: var(--space-16) 0 var(--space-8) 0;
            color: var(--text-muted);
        }
        .prompt-content p { font-size: 1rem; line-height: 1.6; margin: 0; }
        #empty-prompt { text-align: center; padding: var(--space-24); }
        #empty-prompt a { color: var(--primary-blue); font-weight: 700; text-decoration: none; }

        /* --- Text Editor --- */
        .editor-wrapper { position: relative; }
        #editor {
            width: 100%; min-height: 75vh;
            border: 1px solid var(--border-color);
            border-radius: var(--space-12);
            padding: var(--space-32);
            font-family: 'Inter', sans-serif;
            font-size: 1.1rem; line-height: 1.8;
            color: var(--text-dark);
            background-color: var(--panel-white);
            box-sizing: border-box; resize: vertical;
            transition: all 0.4s var(--transition-curve);
        }
        #editor:focus {
            outline: none; border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(0, 82, 204, 0.2);
        }

        /* --- Sensory Palette Sidebar --- */
        #sensory-sidebar {
            position: fixed; top: 0; right: -400px;
            width: 100%; max-width: 360px; height: 100%;
            background-color: var(--panel-white);
            box-shadow: -10px 0 30px rgba(23, 43, 77, 0.1);
            border-left: 1px solid var(--border-color);
            padding: var(--space-24); padding-top: 80px;
            box-sizing: border-box;
            transition: right 0.4s var(--transition-curve);
            z-index: 1001;
        }
        #sensory-sidebar.open { right: 0; }
        #sensory-sidebar h3 { font-weight: 700; margin: 0 0 var(--space-24) 0; font-size: 1.2rem; }
        #sensory-sidebar ul { list-style: none; padding: 0; margin: 0; }
        #sensory-sidebar li { margin-bottom: var(--space-24); }
        #sensory-sidebar li strong {
            display: block; text-transform: uppercase; font-size: 0.9rem;
            margin-bottom: var(--space-8); color: var(--text-muted); font-weight: 700;
        }
        #sensory-sidebar li span { line-height: 1.6; font-size: 1rem; }
        #close-sidebar {
            position: absolute; top: var(--space-16); right: var(--space-16);
            background: none; border: none; cursor: pointer;
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            transition: background-color 0.2s var(--transition-curve);
        }
        #close-sidebar:hover { background-color: var(--bg-light-gray); }

        /* --- On-Demand Thesaurus Popup --- */
        #thesaurus-popup {
            position: absolute; background-color: var(--panel-white);
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 25px rgba(23, 43, 77, 0.15);
            border-radius: var(--space-12); padding: var(--space-16);
            width: 280px; z-index: 1002;
            display: none; font-family: 'Inter', sans-serif;
        }
        #thesaurus-popup h4 {
            font-weight: 700; margin: 0 0 var(--space-12) 0;
            font-size: 1.1rem; border-bottom: 1px solid var(--border-color); padding-bottom: var(--space-12);
        }
        #thesaurus-synonyms { display: flex; flex-wrap: wrap; gap: var(--space-8); }
        #thesaurus-synonyms span {
            background-color: var(--bg-light-gray); padding: 4px 12px;
            border-radius: 6px; font-size: 0.9rem; cursor: pointer;
            transition: background-color 0.2s var(--transition-curve);
        }
        #thesaurus-synonyms span:hover { background-color: #EBF3FF; color: var(--primary-blue); }
        .thesaurus-message { color: var(--text-muted); text-align: center; }

        /* --- Zen Mode --- */
        body.zen-mode .foundry-nav,
        body.zen-mode .tool-header,
        body.zen-mode .prompt-box { opacity: 0; pointer-events: none; transform: translateY(-24px); }
        body.zen-mode #editor {
            border-color: transparent;
            box-shadow: none;
            background-color: var(--bg-light-gray);
        }
        body.zen-mode { background-color: var(--bg-light-gray); }

        /* --- Responsive Design --- */
        @media (max-width: 768px) {
            body { padding: 64px 0 16px 0; }
            .foundry-nav { padding: 0 var(--space-16); }
            .anvil-wrap { padding: 0 var(--space-16); }
            .tool-header { justify-content: center; }
            #editor { padding: var(--space-24); font-size: 1rem; }
        }
    </style>
</head>
<body>
    
    <nav class="foundry-nav">
        <a href="lab.html" class="nav-brand">The Forge</a>
        <div class="nav-links">
            <a href="lab.html">Forge</a>
            <a href="anvil.html" class="active">Anvil</a>
            <a href="journal.html">Journal</a>
        </div>
    </nav>

    <main class="anvil-wrap">
        <div class="tool-header">
            <div class="tool-group" id="tool-group-left"></div>
            <div class="stats-display" id="stats-display">0 words / 0 characters</div>
            <div class="tool-group" id="tool-group-right"></div>
        </div>

        <details class="prompt-box" id="prompt-box">
            <summary>Your Forged Idea</summary>
            <div class="prompt-content" id="prompt-content"></div>
        </details>
        
        <div class="editor-wrapper">
            <textarea id="editor" placeholder="The anvil is ready. Hammer out your story..."></textarea>
            <div id="thesaurus-popup"></div>
        </div>
    </main>

    <aside id="sensory-sidebar">
        <button id="close-sidebar"></button>
        <h3>Sensory Palette</h3>
        <ul id="sensory-list"></ul>
    </aside>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const Anvil = {
            state: { prompt: null, draftKey: 'foundry-default' },
            dom: {},
            icons: {
                zen: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 15.75l-2.489-2.489m0 0a3.375 3.375 0 10-4.773-4.773 3.375 3.375 0 004.774 4.774zM21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
                palette: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.098 19.902a3.75 3.75 0 005.304 0l6.401-6.402a3.75 3.75 0 00-.622-6.321.75.75 0 00-.621.622A3.75 3.75 0 006.402 9.4l-6.402 6.402a3.75 3.75 0 000 5.304z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12.75 12.75L15 15" /></svg>`,
                export: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>`,
                close: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>`
            },
            
            async init() {
                this.cacheDOM();
                this.renderTools();
                this.bindEvents();
                this.state.prompt = this.loadData('foundryAnvilPrompt');
                
                if (this.state.prompt) {
                    this.state.draftKey = `foundry-draft-${this.state.prompt.id}`;
                    this.populateUI();
                    this.dom.editor.value = this.loadData(this.state.draftKey) || '';
                } else {
                    this.displayEmptyState();
                }
                this.updateStats();
            },
            
            cacheDOM() {
                this.dom.editor = document.getElementById('editor');
                this.dom.promptBox = document.getElementById('prompt-box');
                this.dom.promptContent = document.getElementById('prompt-content');
                this.dom.statsDisplay = document.getElementById('stats-display');
                this.dom.sensorySidebar = document.getElementById('sensory-sidebar');
                this.dom.sensoryList = document.getElementById('sensory-list');
                this.dom.closeSidebarBtn = document.getElementById('close-sidebar');
                this.dom.thesaurusPopup = document.getElementById('thesaurus-popup');
                this.dom.toolGroupLeft = document.getElementById('tool-group-left');
                this.dom.toolGroupRight = document.getElementById('tool-group-right');
            },

            renderTools() {
                this.dom.toolGroupLeft.innerHTML = `
                    <button class="tool-btn" id="zen-btn">${this.icons.zen} Zen Mode</button>
                    <button class="tool-btn" id="palette-btn">${this.icons.palette} Palette</button>
                `;
                this.dom.toolGroupRight.innerHTML = `
                    <button class="tool-btn" id="export-txt">${this.icons.export} .txt</button>
                    <button class="tool-btn" id="export-md">${this.icons.export} .md</button>
                `;
                this.dom.closeSidebarBtn.innerHTML = this.icons.close;
            },
            
            bindEvents() {
                let saveTimeout;
                this.dom.editor.addEventListener('input', () => {
                    this.updateStats();
                    clearTimeout(saveTimeout);
                    saveTimeout = setTimeout(() => this.saveData(this.state.draftKey, this.dom.editor.value), 500);
                });
                
                this.dom.editor.addEventListener('dblclick', (e) => this.handleThesaurus(e));
                
                document.getElementById('zen-btn').addEventListener('click', () => document.body.classList.toggle('zen-mode'));
                document.getElementById('palette-btn').addEventListener('click', () => this.dom.sensorySidebar.classList.add('open'));
                this.dom.closeSidebarBtn.addEventListener('click', () => this.dom.sensorySidebar.classList.remove('open'));
                
                document.getElementById('export-txt').addEventListener('click', () => this.exportAs('txt'));
                document.getElementById('export-md').addEventListener('click', () => this.exportAs('md'));
                
                document.addEventListener('click', (e) => {
                    if (!this.dom.thesaurusPopup.contains(e.target) && e.target !== this.dom.editor) {
                        this.dom.thesaurusPopup.style.display = 'none';
                    }
                });
                
                this.dom.thesaurusPopup.addEventListener('click', (e) => {
                    if(e.target.tagName === 'SPAN') {
                        this.replaceSelectedText(e.target.textContent);
                        this.dom.thesaurusPopup.style.display = 'none';
                    }
                });
            },
            
            loadData(key) {
                const dataJSON = localStorage.getItem(key);
                return dataJSON ? JSON.parse(dataJSON) : null;
            },

            saveData(key, data) {
                localStorage.setItem(key, JSON.stringify(data));
            },
            
            populateUI() {
                const { archetype, conflict, setting } = this.state.prompt;
                this.dom.promptContent.innerHTML = `
                    <h3>Archetype</h3><p>${archetype.name}</p>
                    <h3>Conflict</h3><p>${conflict.text}</p>
                    <h3>Setting</h3><p>${setting.name}</p>
                `;
                const palette = setting.sensory_palette;
                this.dom.sensoryList.innerHTML = `
                    <li><strong>Sight</strong><span>${palette.sight}</span></li>
                    <li><strong>Sound</strong><span>${palette.sound}</span></li>
                    <li><strong>Smell</strong><span>${palette.smell}</span></li>
                `;
            },
            
            displayEmptyState() {
                this.dom.promptContent.innerHTML = `<div id="empty-prompt"><p>No idea loaded.</p><a href="lab.html">Forge a new idea &rarr;</a></div>`;
                this.dom.promptBox.open = true;
                document.getElementById('palette-btn').style.opacity = 0.5;
                document.getElementById('palette-btn').disabled = true;
            },
            
            updateStats() {
                const text = this.dom.editor.value;
                const wordCount = text.trim() === '' ? 0 : text.trim().split(/\s+/).length;
                this.dom.statsDisplay.textContent = `${wordCount} words / ${text.length} characters`;
            },
            
            async handleThesaurus(e) {
                const selected = window.getSelection().toString().trim().toLowerCase();
                if (selected.length > 1 && !selected.includes(' ')) {
                    const popup = this.dom.thesaurusPopup;
                    popup.style.display = 'block';
                    popup.style.left = `${e.clientX + 10}px`;
                    popup.style.top = `${e.clientY + 10}px`;
                    popup.innerHTML = `<h4>Synonyms for "${selected}"</h4><div class="thesaurus-message">Fetching...</div>`;
                    
                    try {
                        const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${selected}`);
                        if (!res.ok) throw new Error('Not found');
                        const data = await res.json();
                        const synonyms = data[0]?.meanings.flatMap(m => m.synonyms || []).slice(0, 15);
                        
                        if (synonyms?.length > 0) {
                            popup.innerHTML = `<h4>Synonyms for "${selected}"</h4><div id="thesaurus-synonyms">${[...new Set(synonyms)].map(s => `<span>${s}</span>`).join('')}</div>`;
                        } else {
                            throw new Error('No synonyms found');
                        }
                    } catch (err) {
                        popup.innerHTML = `<h4>Synonyms for "${selected}"</h4><div class="thesaurus-message">${err.message}.</div>`;
                    }
                }
            },

            replaceSelectedText(replacement) {
                this.dom.editor.setRangeText(replacement, this.dom.editor.selectionStart, this.dom.editor.selectionEnd, 'select');
                this.dom.editor.focus();
            },
            
            exportAs(filetype) {
                const content = this.dom.editor.value;
                const blob = new Blob([content], { type: `text/${filetype === 'md' ? 'markdown' : 'plain'};charset=utf-8` });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `foundry-draft.${filetype}`;
                a.click();
                URL.revokeObjectURL(url);
            }
        };

        Anvil.init();
    });
    </script>
</body>
</html>
